<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>æ´—æ¾¡æ’éšŠç³»çµ±</title>
<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;
  background: linear-gradient(135deg,#dfe9f3,#ffffff);
  margin:0; padding:20px; color:#111;
}
.container{ max-width:560px; margin:auto; }
.card{
  background:#fff; padding:18px; border-radius:18px; margin-bottom:16px;
  box-shadow:0 10px 30px rgba(0,0,0,0.08);
}
h1{ text-align:center; font-size:24px; margin:0; }
.status{ font-size:20px; line-height:1.8; }
.now{ color:#2c7be5; font-weight:900; }
.next{ font-weight:900; }
.row{ display:flex; gap:10px; }
input{
  flex:1; padding:12px; border-radius:12px;
  border:1px solid #ddd; font-size:16px;
}
button{
  padding:12px; border-radius:12px; border:none;
  font-weight:900; cursor:pointer;
}
.join{ background:#2c7be5; color:#fff; }
.finish{ width:100%; background:#111; color:#fff; margin-top:10px; }
.back{
  display:inline-block;
  margin-bottom:12px;
  text-decoration:none;
  font-weight:900;
}
</style>
</head>

<body>
<div class="container">

<a class="back" href="index.html">â† å›é¦–é </a>

<div class="card">
  <h1>ğŸš¿ æ´—æ¾¡æ’éšŠç³»çµ±</h1>
</div>

<div class="card status">
  ç¾åœ¨æ´—æ¾¡ï¼š <span id="current" class="now">â€”</span><br>
  ä¸‹ä¸€ä½ï¼š <span id="next" class="next">â€”</span>
</div>

<div class="card">
  <div class="row">
    <input id="nameInput" placeholder="è¼¸å…¥åå­—">
    <button class="join" id="joinBtn">åŠ å…¥</button>
  </div>
  <button class="finish" id="doneBtn">æˆ‘æ´—å¥½äº† â†’ å«ä¸‹ä¸€ä½</button>
</div>

<ul id="queueList"></ul>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import {
  getDatabase, ref, set, push, remove, onValue, get, query, orderByChild, limitToFirst
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBSQAmMKvFjuANWhmZJAYHCwaIUTcwz6A8",
  authDomain: "jade-c8e32.firebaseapp.com",
  databaseURL: "https://jade-c8e32-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "jade-c8e32",
  storageBucket: "jade-c8e32.firebasestorage.app",
  messagingSenderId: "381125332620",
  appId: "1:381125332620:web:642dcf482b06fa3b9f35a9"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const stateCurrentRef = ref(db, "queues/shower/state/current");
const queueRef = ref(db, "queues/shower/queue");

const currentEl = document.getElementById("current");
const nextEl = document.getElementById("next");
const listEl = document.getElementById("queueList");

let queueCache = [];

onValue(stateCurrentRef, snap=>{
  currentEl.innerText = snap.val() || "â€”";
});

onValue(queueRef, snap=>{
  const data = snap.val() || {};
  queueCache = Object.entries(data).map(([k,v])=>({
    key:k,
    name:v.name,
    ts:v.ts
  })).sort((a,b)=>a.ts-b.ts);

  nextEl.innerText = queueCache[0]?.name || "â€”";

  listEl.innerHTML="";
  queueCache.forEach(q=>{
    const li=document.createElement("li");
    li.textContent=q.name;
    listEl.appendChild(li);
  });
});

document.getElementById("joinBtn").addEventListener("click", async ()=>{
  const name=document.getElementById("nameInput").value.trim();
  if(!name) return;

  const curSnap=await get(stateCurrentRef);
  if(!curSnap.exists() || !curSnap.val()){
    await set(stateCurrentRef,name);
  }else{
    await push(queueRef,{name,ts:Date.now()});
  }
  document.getElementById("nameInput").value="";
});

document.getElementById("doneBtn").addEventListener("click", async ()=>{
  if(!confirm("ç¢ºå®šå«ä¸‹ä¸€ä½ï¼Ÿ")) return;

  const q=query(queueRef,orderByChild("ts"),limitToFirst(1));
  const snap=await get(q);

  if(!snap.exists()){
    await set(stateCurrentRef,null);
    return;
  }

  const key=Object.keys(snap.val())[0];
  const nextName=snap.val()[key].name;

  await set(stateCurrentRef,nextName);
  await remove(ref(db,"queues/shower/queue/"+key));
});
</script>

</body>
</html>
