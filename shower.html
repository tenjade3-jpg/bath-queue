<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ç‡ŸéšŠæ´—æ¾¡æ’éšŠç³»çµ±</title>

<style>
  body{
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;
    background: linear-gradient(135deg,#dfe9f3,#ffffff);
    margin:0; padding:20px; color:#111;
  }
  .container{ max-width:560px; margin:auto; }
  .card{
    background:#fff; padding:18px; border-radius:18px; margin-bottom:16px;
    box-shadow:0 10px 30px rgba(0,0,0,0.08);
  }
  h1{ text-align:center; font-size:24px; margin:0; }
  .sub{ text-align:center; opacity:.65; font-size:13px; margin:6px 0 0; }

  .status{ font-size:18px; line-height:1.9; }
  .now{ color:#2c7be5; font-weight:900; }
  .next{ color:#111; font-weight:900; }

  .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  select{
    flex:1; min-width:180px;
    padding:12px 12px; border-radius:12px; border:1px solid #ddd; font-size:16px; outline:none;
    background:#fff;
  }
  select:focus{ border-color:#2c7be5; box-shadow:0 0 0 4px rgba(44,123,229,0.12); }

  button{
    padding:12px 14px; border-radius:12px; border:none; font-size:15px; cursor:pointer;
    white-space:nowrap; font-weight:900;
  }
  .finish{ width:100%; background:#111; color:#fff; margin-top:12px; }
  .ghost{ background:#f3f4f6; border:1px solid #e5e7eb; }

  .hint{ font-size:13px; opacity:.7; margin-top:10px; }
  ul{ padding-left:18px; margin:10px 0 0; }
  li{ margin:8px 0; }

  .backLink{
    display:inline-block;
    margin:0 0 12px;
    text-decoration:none;
    font-weight:900;
    color:#111;
    opacity:.8;
  }
  .backLink:hover{ opacity:1; }

  .pill{
    display:inline-block;
    font-size:12px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid #ddd;
    color:#666;
  }

  .timerLine{
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
    margin-top:6px;
  }
  .remain{
    font-weight:900;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid #e5e7eb;
    background:#f3f4f6;
  }
  .remain.danger{
    border-color:rgba(229,83,83,.35);
    background:rgba(229,83,83,.10);
    color:#a11;
  }

  .slot{
    font-size:12px;
    opacity:.75;
    margin-left:6px;
  }

  /* ç¬¬ä¸‰ä½æé†’ */
  .prepLine{
    margin-top:10px;
    padding:10px 14px;
    border-radius:14px;
    font-weight:900;
    background:rgba(229,83,83,0.10);
    border:1px solid rgba(229,83,83,0.28);
    display:inline-block;
  }
  .prepPulse{ animation: prepPulse 1.2s ease-in-out 0s 2; }
  @keyframes prepPulse{
    0%{ transform:translateY(0) scale(1); box-shadow:0 0 0 rgba(229,83,83,0); }
    40%{ transform:translateY(-4px) scale(1.05); box-shadow:0 15px 30px rgba(229,83,83,0.25); }
    70%{ transform:translateY(0) scale(1); }
    100%{ transform:translateY(0) scale(1); box-shadow:0 0 0 rgba(229,83,83,0); }
  }
</style>
</head>

<body>
<div class="container">
  <a class="backLink" href="index.html">â† å›é¦–é </a>

  <div class="card">
    <h1>ğŸš¿ ç‡ŸéšŠæ´—æ¾¡æ’éšŠç³»çµ±</h1>
    <p class="sub">ï¼ˆrooms + 15 åˆ†é˜è¨ˆæ™‚åˆ¶ï¼‰</p>
  </div>

  <!-- æˆ¿é–“é¸æ“‡ -->
  <div class="card">
    <div class="row">
      <select id="roomSelect"></select>
      <button class="ghost" id="refreshRoomsBtn">é‡æ–°æ•´ç†</button>
    </div>
    <div class="hint" id="roomHint">è¼‰å…¥æˆ¿é–“ä¸­â€¦</div>
    <div class="hint">
      <span class="pill">æ¯äºº 15 åˆ†é˜</span>
      <span class="pill" id="plannedStartPill">é è¨ˆé–‹å§‹ï¼šâ€”</span>
    </div>
    <div class="hint">â€» æ’éšŠèˆ‡åˆ†é…ç”±ç®¡ç†å“¡å®‰æ’ï¼ˆæœ¬é ä¸æä¾›åŠ å…¥æ’éšŠï¼‰</div>
  </div>

  <!-- ç‹€æ…‹ -->
  <div class="card status">
    ç¾åœ¨æ´—æ¾¡ï¼š <span id="current" class="now">â€”</span>
    <div class="timerLine">
      <span>å‰©é¤˜ï¼š</span><span id="remain" class="remain">â€”</span>
      <button class="ghost" id="startTimerBtn" style="display:none;">é–‹å§‹è¨ˆæ™‚ï¼ˆç¾åœ¨æ´—æ¾¡çš„äººæŒ‰ï¼‰</button>
    </div>

    ä¸‹ä¸€ä½ï¼š <span id="next" class="next">â€”</span><br>

    <div id="prepLine" class="prepLine" style="display:none;">
      <span id="next2">â€”</span> æº–å‚™æ´—æ¾¡
    </div>
  </div>

  <!-- ä½¿ç”¨è€…æ“ä½œï¼šåªä¿ç•™é–‹å§‹è¨ˆæ™‚ + å«ä¸‹ä¸€ä½ -->
  <div class="card">
    <button class="finish" id="doneBtn">æˆ‘æ´—å¥½äº† â†’ å«ä¸‹ä¸€ä½</button>
    <div class="hint">ï¼ˆå«ä¸‹ä¸€ä½æœƒé‡ç½® 15 åˆ†é˜è¨ˆæ™‚ï¼Œè®“ä¸‹ä¸€ä½å†æŒ‰é–‹å§‹ï¼‰</div>
  </div>

  <!-- åå–® -->
  <div class="card">
    <h3 style="margin:0 0 8px;">æ’éšŠåå–®ï¼ˆå«é ä¼°æ™‚é–“ï¼‰</h3>
    <div id="queueEmpty" style="opacity:.6;">ï¼ˆç›®å‰æ²’æœ‰äººæ’éšŠï¼‰</div>
    <ul id="queueList"></ul>
  </div>

  <audio id="beep" preload="auto"
    src="data:audio/wav;base64,UklGRlQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQwAAAAA/////wAAAP////8AAAD/////AAAA/////wAAAP////8AAAD/////AAAA/////wAAAP////8="></audio>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import {
  getDatabase, ref, set, remove, onValue, get, query, orderByChild, limitToFirst
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBSQAmMKvFjuANWhmZJAYHCwaIUTcwz6A8",
  authDomain: "jade-c8e32.firebaseapp.com",
  databaseURL: "https://jade-c8e32-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "jade-c8e32",
  storageBucket: "jade-c8e32.firebasestorage.app",
  messagingSenderId: "381125332620",
  appId: "1:381125332620:web:642dcf482b06fa3b9f35a9"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const DURATION_MS = 15 * 60 * 1000;

const roomSelect = document.getElementById("roomSelect");
const roomHint = document.getElementById("roomHint");
const plannedStartPill = document.getElementById("plannedStartPill");

const currentEl = document.getElementById("current");
const nextEl = document.getElementById("next");
const next2El = document.getElementById("next2");
const prepLineEl = document.getElementById("prepLine");

const remainEl = document.getElementById("remain");
const startTimerBtn = document.getElementById("startTimerBtn");

const listEl = document.getElementById("queueList");
const emptyEl = document.getElementById("queueEmpty");

let roomMap = {};
let roomId = "";
let queueCache = [];
let lastPrepName = "";

// schedule/timer cache
let plannedStartAt = null;
let timer = null;

// unsub
let unsubRooms=null, unsubCurrent=null, unsubQueue=null, unsubSchedule=null, unsubTimer=null;

function playBeep(){
  const a = document.getElementById("beep");
  if(!a) return;
  a.currentTime = 0;
  const p = a.play();
  if(p && p.catch) p.catch(()=>{});
}

function fmtHHMM(ms){
  if(!ms) return "â€”";
  const d = new Date(ms);
  const hh = String(d.getHours()).padStart(2,"0");
  const mm = String(d.getMinutes()).padStart(2,"0");
  return `${hh}:${mm}`;
}

function fmtRemain(ms){
  if(ms == null) return "â€”";
  const s = Math.max(0, Math.floor(ms/1000));
  const mm = String(Math.floor(s/60)).padStart(2,"0");
  const ss = String(s%60).padStart(2,"0");
  return `${mm}:${ss}`;
}

function detachRoomListeners(){
  if(unsubCurrent) unsubCurrent();
  if(unsubQueue) unsubQueue();
  if(unsubSchedule) unsubSchedule();
  if(unsubTimer) unsubTimer();
  unsubCurrent=unsubQueue=unsubSchedule=unsubTimer=null;
}

function roomsRef(){ return ref(db, `queues/shower/rooms`); }
function roomRoot(){ return `queues/shower/rooms/${roomId}`; }
function stateCurrentRef(){ return ref(db, `${roomRoot()}/state/current`); }
function queueRef(){ return ref(db, `${roomRoot()}/queue`); }
function scheduleRef(){ return ref(db, `${roomRoot()}/schedule/plannedStartAt`); }
function timerRef(){ return ref(db, `${roomRoot()}/timer`); }

function renderRooms(){
  roomSelect.innerHTML = "";
  const entries = Object.entries(roomMap || {});
  if(entries.length === 0){
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "ï¼ˆç›®å‰æ²’æœ‰æˆ¿é–“ï¼‰";
    roomSelect.appendChild(opt);
    roomId = "";
    roomHint.textContent = "ç›®å‰æ²’æœ‰æˆ¿é–“ï¼Œè«‹ç®¡ç†å“¡åˆ° admin.html æ–°å¢æ·‹æµ´é–“ã€‚";
    plannedStartPill.textContent = "é è¨ˆé–‹å§‹ï¼šâ€”";
    return;
  }

  entries.sort((a,b)=> String(a[1]?.name||"").localeCompare(String(b[1]?.name||""), "zh-Hant"));
  if(!roomId || !roomMap[roomId]) roomId = entries[0][0];

  for(const [id, v] of entries){
    const opt = document.createElement("option");
    opt.value = id;
    opt.textContent = v?.name ? v.name : id;
    opt.selected = (id === roomId);
    roomSelect.appendChild(opt);
  }
  roomHint.textContent = `ç›®å‰é¸æ“‡ï¼š${roomMap?.[roomId]?.name || roomId}`;
}

function updateThirdLine(){
  nextEl.innerText = queueCache[0]?.name || "â€”";

  const prepName = queueCache[1]?.name || "";
  if(prepName){
    next2El.innerText = prepName;
    prepLineEl.style.display = "inline-block";

    if(prepName !== lastPrepName){
      lastPrepName = prepName;
      prepLineEl.classList.remove("prepPulse");
      void prepLineEl.offsetWidth;
      prepLineEl.classList.add("prepPulse");
    }
  }else{
    prepLineEl.style.display = "none";
    lastPrepName = "";
  }
}

function computeElapsedMs(t, nowMs){
  if(!t || !t.startAt) return 0;
  const base = (t.isRunning ? nowMs : (t.pausedAt || nowMs)) - t.startAt;
  return Math.max(0, base - (t.pausedTotalMs || 0));
}

function computeRemainMs(t, nowMs){
  if(!t || !t.startAt) return null;
  const elapsed = computeElapsedMs(t, nowMs);
  return Math.max(0, (t.durationMs || DURATION_MS) - elapsed);
}

function renderPlannedStart(){
  plannedStartPill.textContent = `é è¨ˆé–‹å§‹ï¼š${plannedStartAt ? fmtHHMM(plannedStartAt) : "â€”"}`;
}

function renderTimerUI(){
  const curName = (currentEl.textContent || "").trim();
  const nowMs = Date.now();

  const remainMs = computeRemainMs(timer, nowMs);
  remainEl.textContent = fmtRemain(remainMs);

  const danger = (remainMs != null && remainMs <= 60*1000);
  remainEl.classList.toggle("danger", !!danger);

  // æœ‰ current ä¸” timer å°šæœª start -> é¡¯ç¤ºé–‹å§‹æŒ‰éˆ•
  const showStart = !!curName && curName !== "â€”" && (!timer || !timer.startAt);
  startTimerBtn.style.display = showStart ? "inline-block" : "none";
}

function estimateBaseStartMs(){
  if(timer && timer.startAt) return timer.startAt;
  if(plannedStartAt) return plannedStartAt;
  return null;
}

function renderQueueListWithEstimates(){
  listEl.innerHTML = "";
  if(queueCache.length === 0){
    emptyEl.style.display = "block";
    return;
  }
  emptyEl.style.display = "none";

  const baseStart = estimateBaseStartMs();
  const nowMs = Date.now();
  const remainMs = computeRemainMs(timer, nowMs);

  let currentEnd = null;
  if(timer && timer.startAt){
    currentEnd = nowMs + (remainMs ?? DURATION_MS);
  }else if(baseStart){
    currentEnd = baseStart + DURATION_MS;
  }

  queueCache.forEach((q, idx)=>{
    const li = document.createElement("li");

    const nameSpan = document.createElement("span");
    nameSpan.textContent = q.name;

    const slotSpan = document.createElement("span");
    slotSpan.className = "slot";

    if(currentEnd){
      const slotStart = currentEnd + idx * DURATION_MS;
      const slotEnd = slotStart + DURATION_MS;
      slotSpan.textContent = `ï¼ˆé ä¼°ï¼š${fmtHHMM(slotStart)}~${fmtHHMM(slotEnd)}ï¼‰`;
    }else{
      slotSpan.textContent = "ï¼ˆé ä¼°ï¼šâ€”ï¼‰";
    }

    li.appendChild(nameSpan);
    li.appendChild(slotSpan);
    listEl.appendChild(li);
  });
}

function attachRoomListeners(){
  detachRoomListeners();
  if(!roomId) return;

  unsubCurrent = onValue(stateCurrentRef(), (snap)=>{
    currentEl.innerText = (snap.exists() && snap.val()) ? snap.val() : "â€”";
    renderTimerUI();
    renderQueueListWithEstimates();
  });

  unsubSchedule = onValue(scheduleRef(), (snap)=>{
    plannedStartAt = snap.exists() && snap.val() ? Number(snap.val()) : null;
    renderPlannedStart();
    renderQueueListWithEstimates();
  });

  unsubTimer = onValue(timerRef(), (snap)=>{
    timer = snap.exists() ? (snap.val() || null) : null;
    renderTimerUI();
    renderQueueListWithEstimates();
  });

  unsubQueue = onValue(queueRef(), (snap)=>{
    const data = snap.val() || {};
    const arr = Object.entries(data).map(([key, v]) => ({
      key,
      name: v?.name ?? "",
      ts: v?.ts ?? 0
    })).filter(x => String(x.name).trim());

    arr.sort((a,b)=>a.ts-b.ts);
    queueCache = arr;

    updateThirdLine();
    renderQueueListWithEstimates();
  });
}

function loadRooms(){
  if(unsubRooms) unsubRooms();
  roomHint.textContent = "è¼‰å…¥æˆ¿é–“ä¸­â€¦";

  unsubRooms = onValue(roomsRef(), (snap)=>{
    roomMap = snap.val() || {};
    renderRooms();
    attachRoomListeners();
  });
}

roomSelect.addEventListener("change", ()=>{
  roomId = roomSelect.value;
  renderRooms();
  attachRoomListeners();
});
document.getElementById("refreshRoomsBtn").addEventListener("click", loadRooms);

// æ¯ç§’åˆ·æ–°å‰©é¤˜æ™‚é–“ï¼ˆç´”é¡¯ç¤ºï¼Œä¸å¯« DBï¼‰
setInterval(()=>{
  if(!roomId) return;
  renderTimerUI();
}, 1000);

/** actions **/
startTimerBtn.addEventListener("click", async ()=>{
  if(!roomId) return;
  const curName = String(currentEl.textContent || "").trim();
  if(!curName || curName==="â€”") return alert("ç›®å‰æ²’æœ‰ã€Œç¾åœ¨æ´—æ¾¡ã€çš„äºº");

  const snap = await get(timerRef());
  const t = snap.exists() ? (snap.val() || {}) : {};

  if(t.startAt) return; // å·²é–‹å§‹å°±ä¸é‡è¤‡é–‹å§‹

  const newTimer = {
    durationMs: DURATION_MS,
    startAt: Date.now(),
    isRunning: true,
    pausedAt: null,
    pausedTotalMs: 0
  };
  await set(timerRef(), newTimer);
});

document.getElementById("doneBtn").addEventListener("click", async ()=>{
  if(!roomId) return alert("ç›®å‰æ²’æœ‰æˆ¿é–“å¯é¸ï¼Œè«‹å…ˆè«‹ç®¡ç†å“¡æ–°å¢ã€‚");
  if(!confirm("ç¢ºå®šä½ æ´—å¥½äº†ï¼Œè¦å«ä¸‹ä¸€ä½å—ï¼Ÿ")) return;

  const q = query(queueRef(), orderByChild("ts"), limitToFirst(1));
  const snap = await get(q);

  if(!snap.exists()){
    await set(stateCurrentRef(), null);
    await set(timerRef(), { durationMs: DURATION_MS, startAt: null, isRunning: false, pausedAt: null, pausedTotalMs: 0 });
    playBeep();
    return;
  }

  const firstKey = Object.keys(snap.val())[0];
  const nextName = snap.val()[firstKey]?.name || "";

  await set(stateCurrentRef(), nextName);
  await remove(ref(db, `${roomRoot()}/queue/${firstKey}`));

  await set(timerRef(), { durationMs: DURATION_MS, startAt: null, isRunning: false, pausedAt: null, pausedTotalMs: 0 });
  playBeep();
});

loadRooms();
</script>
</body>
</html>
