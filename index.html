<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ç‡ŸéšŠæ´—æ¾¡æ’éšŠç³»çµ±</title>

<style>
  body{
    font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
    background: linear-gradient(135deg,#dfe9f3,#ffffff);
    margin:0;
    padding:20px;
    color:#111;
  }
  .container{ max-width:520px; margin:auto; }
  .card{
    background:white;
    padding:18px;
    border-radius:18px;
    margin-bottom:16px;
    box-shadow:0 10px 30px rgba(0,0,0,0.08);
  }
  h1{
    text-align:center;
    font-size:24px;
    margin:6px 0 2px;
  }
  .sub{
    text-align:center;
    opacity:.65;
    font-size:13px;
    margin:0;
  }
  .status{
    font-size:20px;
    line-height:1.8;
  }
  .now{ color:#2c7be5; font-weight:800; }
  .next{ color:#e55353; font-weight:800; }

  .row{ display:flex; gap:10px; align-items:center; }
  input{
    flex:1;
    padding:12px 12px;
    border-radius:12px;
    border:1px solid #ddd;
    font-size:16px;
    outline:none;
  }
  input:focus{ border-color:#2c7be5; box-shadow:0 0 0 4px rgba(44,123,229,0.12); }

  button{
    padding:12px 14px;
    border-radius:12px;
    border:none;
    font-size:15px;
    cursor:pointer;
    white-space:nowrap;
  }
  .join{ background:#2c7be5; color:white; font-weight:700; }
  .finish{
    width:100%;
    background:#111;
    color:white;
    margin-top:12px;
    font-weight:800;
  }
  .hint{ margin-top:10px; font-size:13px; opacity:.7; }

  ul{ padding-left:18px; margin:10px 0 0; }
  li{ margin:6px 0; }

  .adminTop{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
  }
  .pill{
    border:1px solid #ddd;
    border-radius:999px;
    padding:8px 12px;
    font-size:13px;
    opacity:.8;
  }
  .adminBtn{ background:#f3f4f6; font-weight:700; }
  .danger{ background:#e55353; color:white; font-weight:800; }
  .ghost{ background:#f3f4f6; font-weight:700; }
  .adminPanel{ display:none; margin-top:12px; }
  .adminPanel.show{ display:block; }

  .qitem{
    display:flex;
    gap:8px;
    align-items:center;
    justify-content:space-between;
    padding:10px 12px;
    border:1px solid #eee;
    border-radius:14px;
    margin-top:10px;
    background:#fff;
  }
  .qname{ font-weight:800; }
  .qtools{ display:flex; gap:8px; }
  .mini{ padding:8px 10px; border-radius:10px; font-size:13px; }
  .miniUpDown{ background:#f3f4f6; font-weight:800; }
  .miniDel{ background:#111; color:#fff; font-weight:800; }
  .miniNow{ background:#2c7be5; color:#fff; font-weight:800; }

  .divider{ height:1px; background:#eee; margin:14px 0; }
</style>
</head>

<body>
<div class="container">

  <div class="card">
    <h1>ğŸš¿ ç‡ŸéšŠæ´—æ¾¡æ’éšŠç³»çµ±</h1>
    <p class="sub">Realtime Database é€£ç·šä¸­</p>
  </div>

  <div class="card status">
    ç¾åœ¨æ´—æ¾¡ï¼š <span id="current" class="now">â€”</span><br>
    ä¸‹ä¸€ä½æº–å‚™ï¼š <span id="next" class="next">â€”</span>
  </div>

  <div class="card">
    <div class="row">
      <input id="nameInput" placeholder="è¼¸å…¥åå­—ï¼ˆNameï¼‰" maxlength="20">
      <button class="join" onclick="joinQueue()">åŠ å…¥æ’éšŠ</button>
    </div>
    <button class="finish" onclick="nextPerson()">æˆ‘æ´—å¥½äº† â†’ å«ä¸‹ä¸€ä½</button>
    <div class="hint">æç¤ºï¼šæŒ‰ã€Œå«ä¸‹ä¸€ä½ã€æœƒè·³å‡ºç¢ºèªè¦–çª—ï¼Œä¸¦æ’­æ”¾æç¤ºéŸ³ã€‚</div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px;">æ’éšŠåå–®</h3>
    <div id="queueEmpty" style="opacity:.6;">ï¼ˆç›®å‰æ²’æœ‰äººæ’éšŠï¼‰</div>
    <ul id="queueList"></ul>
  </div>

  <!-- å·¥ä½œäººå“¡ -->
  <div class="card">
    <div class="adminTop">
      <div class="pill">ğŸ›  å·¥ä½œäººå“¡æ§åˆ¶</div>
      <button class="adminBtn" onclick="toggleAdmin()">å·¥ä½œäººå“¡ç™»å…¥ / é€€å‡º</button>
    </div>

    <div id="adminPanel" class="adminPanel">
      <div class="divider"></div>

      <div class="row">
        <input id="adminAddName" placeholder="å·¥ä½œäººå“¡æ–°å¢ï¼šè¼¸å…¥åå­—" maxlength="20">
        <button class="ghost" onclick="adminAddToQueue()">æ–°å¢åˆ°éšŠä¼</button>
      </div>

      <div style="display:flex; gap:10px; margin-top:12px;">
        <button class="ghost" style="flex:1;" onclick="adminClearCurrent()">æ¸…ç©ºã€Œç¾åœ¨æ´—æ¾¡ã€</button>
        <button class="danger" style="flex:1;" onclick="adminClearQueue()">æ¸…ç©ºæ•´å€‹éšŠä¼</button>
      </div>

      <div class="divider"></div>
      <div style="font-weight:800; margin-bottom:6px;">éšŠä¼èª¿æ•´ï¼ˆä¸Š/ä¸‹ç§»ã€åˆªé™¤ã€è¨­ç‚ºç¾åœ¨æ´—æ¾¡ï¼‰</div>
      <div id="adminQueueBox"></div>

      <div class="hint">âš ï¸ é€™æ˜¯å‰ç«¯å¯†ç¢¼ç‰ˆæœ¬ï¼ŒçœŸæ­£å®‰å…¨è¦ç”¨ Firebase Auth + Rulesã€‚</div>
    </div>
  </div>

</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import {
    getDatabase, ref, set, push, remove, onValue
  } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

  // ====== ä½ æ”¹é€™è£¡ï¼šå·¥ä½œäººå“¡å¯†ç¢¼ ======
  const ADMIN_PASSWORD = "1234"; // æ”¹æˆä½ çš„
  // =================================

  const firebaseConfig = {
    apiKey: "AIzaSyBSQAmMKvFjuANWhmZJAYHCwaIUTcwz6A8",
    authDomain: "jade-c8e32.firebaseapp.com",
    databaseURL: "https://jade-c8e32-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "jade-c8e32",
    storageBucket: "jade-c8e32.firebasestorage.app",
    messagingSenderId: "381125332620",
    appId: "1:381125332620:web:642dcf482b06fa3b9f35a9"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const currentEl = document.getElementById("current");
  const nextEl = document.getElementById("next");
  const listEl = document.getElementById("queueList");
  const emptyEl = document.getElementById("queueEmpty");
  const adminPanel = document.getElementById("adminPanel");
  const adminQueueBox = document.getElementById("adminQueueBox");

  let isAdmin = false;
  let queueCache = []; // [{key, name}]

  // ---------- éŸ³æ•ˆï¼šç”¨ WebAudio åšæç¤ºéŸ³ ----------
  function playBeep(){
    try{
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      const ctx = new AudioContext();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = "sine";
      o.frequency.value = 880;
      g.gain.value = 0.05;
      o.connect(g);
      g.connect(ctx.destination);
      o.start();
      setTimeout(()=>{ o.stop(); ctx.close(); }, 180);
    }catch(e){
      // å¦‚æœè£ç½®ä¸æ”¯æ´å°±ç•¥é
      console.log("beep failed", e);
    }
  }

  // ---------- ä¸€èˆ¬ä½¿ç”¨è€…ï¼šåŠ å…¥æ’éšŠ ----------
  window.joinQueue = function(){
    const name = document.getElementById("nameInput").value.trim();
    if(!name) return;

    const currentRef = ref(db,"state/current");

    onValue(currentRef,(snap)=>{
      if(!snap.exists() || snap.val() === null || snap.val() === ""){
        // æ²’äººæ´—æ¾¡ -> ç›´æ¥ç•¶ç¾åœ¨æ´—æ¾¡
        set(currentRef, name);
      }else{
        // æœ‰äºº -> é€²éšŠä¼
        push(ref(db,"queue"), { name });
      }
    },{ onlyOnce:true });

    document.getElementById("nameInput").value="";
  }

  // ---------- ä¸€èˆ¬ä½¿ç”¨è€…ï¼šå«ä¸‹ä¸€ä½ï¼ˆæœ‰ç¢ºèªè¦–çª— + éŸ³æ•ˆï¼‰ ----------
  window.nextPerson = function(){
    const ok = confirm("ç¢ºå®šä½ æ´—å¥½äº†ï¼Œè¦å«ä¸‹ä¸€ä½å—ï¼Ÿ");
    if(!ok) return;

    const queueRef = ref(db,"queue");
    onValue(queueRef,(snap)=>{
      const data = snap.val();

      if(!data){
        // æ²’äººæ’éšŠ -> æ¸…ç©º current
        set(ref(db,"state/current"), null);
        playBeep();
        return;
      }

      const keys = Object.keys(data);
      const firstKey = keys[0];
      const nextName = data[firstKey].name;

      set(ref(db,"state/current"), nextName);
      remove(ref(db,"queue/"+firstKey));
      playBeep();
    },{ onlyOnce:true });
  }

  // ---------- å·¥ä½œäººå“¡ï¼šç™»å…¥/é€€å‡º ----------
  window.toggleAdmin = function(){
    if(!isAdmin){
      const pw = prompt("è¼¸å…¥å·¥ä½œäººå“¡å¯†ç¢¼ï¼š");
      if(pw === null) return;
      if(pw !== ADMIN_PASSWORD){
        alert("å¯†ç¢¼éŒ¯èª¤");
        return;
      }
      isAdmin = true;
      adminPanel.classList.add("show");
      alert("å·¥ä½œäººå“¡æ¨¡å¼å·²é–‹å•Ÿ âœ…");
    }else{
      isAdmin = false;
      adminPanel.classList.remove("show");
      alert("å·²é€€å‡ºå·¥ä½œäººå“¡æ¨¡å¼");
    }
  }

  // ---------- å·¥ä½œäººå“¡ï¼šæ–°å¢åˆ°éšŠä¼ ----------
  window.adminAddToQueue = function(){
    if(!isAdmin) return alert("è«‹å…ˆç™»å…¥å·¥ä½œäººå“¡æ¨¡å¼");
    const name = document.getElementById("adminAddName").value.trim();
    if(!name) return;
    push(ref(db,"queue"), { name });
    document.getElementById("adminAddName").value="";
  }

  // ---------- å·¥ä½œäººå“¡ï¼šæ¸…ç©ºç¾åœ¨æ´—æ¾¡ ----------
  window.adminClearCurrent = function(){
    if(!isAdmin) return alert("è«‹å…ˆç™»å…¥å·¥ä½œäººå“¡æ¨¡å¼");
    if(!confirm("ç¢ºå®šè¦æ¸…ç©ºã€ç¾åœ¨æ´—æ¾¡ã€å—ï¼Ÿ")) return;
    set(ref(db,"state/current"), null);
  }

  // ---------- å·¥ä½œäººå“¡ï¼šæ¸…ç©ºæ•´å€‹éšŠä¼ ----------
  window.adminClearQueue = function(){
    if(!isAdmin) return alert("è«‹å…ˆç™»å…¥å·¥ä½œäººå“¡æ¨¡å¼");
    if(!confirm("ç¢ºå®šè¦æ¸…ç©ºæ•´å€‹æ’éšŠåå–®å—ï¼Ÿ")) return;
    set(ref(db,"queue"), null);
  }

  // ---------- å·¥ä½œäººå“¡ï¼šéšŠä¼é‡æ’ï¼ˆrewrite queueï¼‰ ----------
  async function rewriteQueueFromCache(){
    // ä¾ç…§ queueCache é †åºé‡æ–°å¯«å›å»ï¼ˆä¿æŒ nameï¼‰
    const obj = {};
    // ç”¨åŸ key ç¶­æŒè³‡æ–™ä¸€è‡´ï¼ˆä¹Ÿå¯ä»¥é‡å»ºæ–° keyï¼Œä½†é€™æ¨£æ¯”è¼ƒç›´è¦ºï¼‰
    queueCache.forEach(item => { obj[item.key] = { name: item.name }; });
    await set(ref(db,"queue"), Object.keys(obj).length ? obj : null);
  }

  window.adminMoveUp = async function(key){
    if(!isAdmin) return alert("è«‹å…ˆç™»å…¥å·¥ä½œäººå“¡æ¨¡å¼");
    const idx = queueCache.findIndex(x=>x.key===key);
    if(idx <= 0) return;
    [queueCache[idx-1], queueCache[idx]] = [queueCache[idx], queueCache[idx-1]];
    await rewriteQueueFromCache();
  }

  window.adminMoveDown = async function(key){
    if(!isAdmin) return alert("è«‹å…ˆç™»å…¥å·¥ä½œäººå“¡æ¨¡å¼");
    const idx = queueCache.findIndex(x=>x.key===key);
    if(idx < 0 || idx >= queueCache.length-1) return;
    [queueCache[idx+1], queueCache[idx]] = [queueCache[idx], queueCache[idx+1]];
    await rewriteQueueFromCache();
  }

  window.adminDelete = async function(key){
    if(!isAdmin) return alert("è«‹å…ˆç™»å…¥å·¥ä½œäººå“¡æ¨¡å¼");
    if(!confirm("ç¢ºå®šè¦æŠŠé€™å€‹äººå¾éšŠä¼ç§»é™¤å—ï¼Ÿ")) return;
    await remove(ref(db,"queue/"+key));
  }

  window.adminSetNow = async function(key){
    if(!isAdmin) return alert("è«‹å…ˆç™»å…¥å·¥ä½œäººå“¡æ¨¡å¼");
    const person = queueCache.find(x=>x.key===key);
    if(!person) return;

    if(!confirm(`ç¢ºå®šè¦æŠŠã€Œ${person.name}ã€è¨­ç‚ºç¾åœ¨æ´—æ¾¡å—ï¼Ÿï¼ˆä¸¦å¾éšŠä¼ç§»é™¤ï¼‰`)) return;

    await set(ref(db,"state/current"), person.name);
    await remove(ref(db,"queue/"+key));
    playBeep();
  }

  // ---------- ç›£è½ current ----------
  onValue(ref(db,"state/current"),(snap)=>{
    currentEl.innerText = (snap.exists() && snap.val()) ? snap.val() : "â€”";
  });

  // ---------- ç›£è½ queue ----------
  onValue(ref(db,"queue"),(snap)=>{
    listEl.innerHTML="";
    adminQueueBox.innerHTML="";
    queueCache = [];

    const data = snap.val();

    if(!data){
      emptyEl.style.display = "block";
      nextEl.innerText = "â€”";
      return;
    }

    emptyEl.style.display = "none";
    const keys = Object.keys(data);
    queueCache = keys.map(k => ({ key:k, name:data[k].name }));

    // ä¸‹ä¸€ä½
    nextEl.innerText = queueCache[0]?.name ?? "â€”";

    // ä¸€èˆ¬åå–®é¡¯ç¤º
    queueCache.forEach(item=>{
      const li = document.createElement("li");
      li.innerText = item.name;
      listEl.appendChild(li);
    });

    // å·¥ä½œäººå“¡éšŠä¼æ§åˆ¶ UI
    queueCache.forEach((item, idx)=>{
      const row = document.createElement("div");
      row.className = "qitem";

      const left = document.createElement("div");
      left.innerHTML = `<span class="qname">${idx+1}. ${item.name}</span>`;

      const tools = document.createElement("div");
      tools.className = "qtools";
      tools.innerHTML = `
        <button class="mini miniNow" onclick="adminSetNow('${item.key}')">è¨­ç‚ºç¾åœ¨</button>
        <button class="mini miniUpDown" onclick="adminMoveUp('${item.key}')">â†‘</button>
        <button class="mini miniUpDown" onclick="adminMoveDown('${item.key}')">â†“</button>
        <button class="mini miniDel" onclick="adminDelete('${item.key}')">åˆª</button>
      `;

      row.appendChild(left);
      row.appendChild(tools);
      adminQueueBox.appendChild(row);
    });
  });

</script>
</body>
</html>
