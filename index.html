<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ´—æ¾¡æ’éšŠç³»çµ±</title>

  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --border:#d9d9d9;
      --muted:#666;
      --black:#111;
      --radius:18px;
    }

    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC",
                   "Helvetica Neue", Arial, "Microsoft JhengHei", sans-serif;
      background: var(--bg);
      color:#111;
    }

    .wrap{
      max-width: 420px;
      margin: 0 auto;
      padding: 18px 16px 40px;
    }

    .card{
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
      margin: 14px 0;
    }

    .title{
      display:flex;
      align-items:center;
      gap:10px;
      font-size: 30px;
      font-weight: 900;
      letter-spacing: .5px;
    }

    .title .emoji{ font-size: 28px; }

    .status{
      font-size: 34px;
      font-weight: 900;
      line-height: 1.25;
    }
    .status small{
      display:block;
      font-size: 14px;
      color: var(--muted);
      font-weight: 600;
      margin-top: 8px;
    }

    .row{
      display:flex;
      gap: 12px;
      align-items:center;
    }

    input{
      flex:1;
      font-size: 18px;
      padding: 14px 14px;
      border: 2px solid var(--border);
      border-radius: 14px;
      outline: none;
    }
    input:focus{ border-color:#bdbdbd; }

    button{
      border: 0;
      border-radius: 14px;
      padding: 14px 16px;
      font-size: 18px;
      font-weight: 900;
      cursor: pointer;
    }

    .btn-black{
      background: var(--black);
      color: #fff;
      white-space: nowrap;
    }

    .btn-black:active{ transform: scale(0.99); }

    .list-title{
      font-size: 34px;
      font-weight: 900;
    }

    .queue{
      margin-top: 10px;
      padding-left: 22px;
      font-size: 18px;
      line-height: 1.8;
    }

    .hint{
      color: var(--muted);
      font-size: 13px;
      line-height: 1.5;
    }

    .pill{
      display:inline-block;
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- æ¨™é¡Œ -->
    <div class="card">
      <div class="title"><span class="emoji">ğŸš¿</span>æ´—æ¾¡æ’éšŠç³»çµ±</div>
      <div class="pill">Realtime Database</div>
    </div>

    <!-- ç‹€æ…‹ -->
    <div class="card">
      <div class="status">
        ç¾åœ¨æ´—æ¾¡ï¼š <span id="nowName">â€”</span><br>
        ä¸‹ä¸€ä½æº–å‚™ï¼š <span id="nextName">â€”</span>
        <small>Now / Next</small>
      </div>
    </div>

    <!-- ä½ èªªçš„ input divï¼ˆå¤–æ¡† + å…§æ’ç‰ˆï¼‰ -->
    <div class="card" id="inputBox">
      <div class="row">
        <input id="nameInput" placeholder="è¼¸å…¥åå­—ï¼ˆNameï¼‰" />
        <button class="btn-black" id="addBtn">åŠ å…¥æ’éšŠ</button>
      </div>
      <div class="hint" style="margin-top:10px;">
        ï¼Šå¦‚æœç›®å‰æ²’äººæ´—æ¾¡ï¼Œä½ æœƒç›´æ¥è®Šæˆã€Œç¾åœ¨æ´—æ¾¡ã€ã€‚
      </div>
    </div>

    <!-- å«ä¸‹ä¸€ä½ -->
    <div class="card">
      <button class="btn-black" id="nextBtn" style="width:100%;">æˆ‘æ´—å¥½äº† â†’ å«ä¸‹ä¸€ä½</button>
      <div class="hint" style="margin-top:10px;">
        ï¼ŠæœƒæŠŠéšŠä¼ç¬¬ä¸€å€‹äººå«ä¸Šä¾†ã€‚
      </div>
    </div>

    <!-- æ’éšŠåå–® -->
    <div class="card">
      <div class="list-title">æ’éšŠåå–®</div>
      <ol class="queue" id="queueList"></ol>
      <div class="hint" id="queueHint">ï¼ˆç›®å‰æ²’æœ‰äººæ’éšŠï¼‰</div>
    </div>

    <div class="hint">
      å¦‚æœæŒ‰éˆ•æ²’åæ‡‰ï¼šè«‹æ‰“é–‹ç€è¦½å™¨ DevTools Console çœ‹æ˜¯å¦æ˜¯ Firebase è¦å‰‡æ‹’çµ•ï¼ˆpermission deniedï¼‰ã€‚
    </div>

  </div>

  <script type="module">
    // Firebase (CDN modular SDK)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import {
      getDatabase, ref, push, set, get, remove,
      onValue, query, orderByChild, limitToFirst
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

    // âœ… ä½ çš„ Firebase è¨­å®šï¼ˆä½ è²¼çš„é‚£æ®µï¼‰
    const firebaseConfig = {
      apiKey: "AIzaSyBSQAmMKvFjuANWhmZJAYHCwaIUTcwz6A8",
      authDomain: "jade-c8e32.firebaseapp.com",
      databaseURL: "https://jade-c8e32-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "jade-c8e32",
      storageBucket: "jade-c8e32.firebasestorage.app",
      messagingSenderId: "381125332620",
      appId: "1:381125332620:web:642dcf482b06fa3b9f35a9"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // Refs
    const stateRef = ref(db, "state");      // { current: "åå­—" }
    const queueRef = ref(db, "queue");      // push list: {name, ts}

    // UI
    const nowNameEl  = document.getElementById("nowName");
    const nextNameEl = document.getElementById("nextName");
    const queueListEl= document.getElementById("queueList");
    const queueHintEl= document.getElementById("queueHint");
    const nameInput  = document.getElementById("nameInput");
    const addBtn     = document.getElementById("addBtn");
    const nextBtn    = document.getElementById("nextBtn");

    // Helpers
    const safeText = (v) => (v && String(v).trim()) ? String(v).trim() : "â€”";

    function renderQueue(items){
      queueListEl.innerHTML = "";
      if (!items.length){
        queueHintEl.style.display = "block";
        queueHintEl.textContent = "ï¼ˆç›®å‰æ²’æœ‰äººæ’éšŠï¼‰";
        return;
      }
      queueHintEl.style.display = "none";
      for (const it of items){
        const li = document.createElement("li");
        li.textContent = it.name;
        queueListEl.appendChild(li);
      }
    }

    // Live state
    let currentName = "";
    let queueItems = [];

    onValue(stateRef, (snap) => {
      const val = snap.val() || {};
      currentName = val.current || "";
      nowNameEl.textContent = safeText(currentName);
      // nextName ç”± queueItems æ±ºå®š
      nextNameEl.textContent = safeText(queueItems[0]?.name);
    });

    // Live queue (sorted by ts)
    onValue(queueRef, (snap) => {
      const val = snap.val() || {};
      const arr = Object.entries(val).map(([key, obj]) => ({
        key,
        name: obj?.name ?? "",
        ts: obj?.ts ?? 0
      })).filter(x => String(x.name).trim());

      arr.sort((a,b) => a.ts - b.ts);
      queueItems = arr;

      renderQueue(queueItems);
      nextNameEl.textContent = safeText(queueItems[0]?.name);
    });

    // Add to queue
    addBtn.addEventListener("click", async () => {
      try{
        const name = String(nameInput.value || "").trim();
        if (!name){
          alert("è«‹è¼¸å…¥åå­—");
          return;
        }

        // è®€ä¸€æ¬¡ state.current
        const stSnap = await get(stateRef);
        const stVal = stSnap.val() || {};
        const cur = String(stVal.current || "").trim();

        if (!cur){
          // æ²’äººæ´—æ¾¡ â†’ ç›´æ¥ç•¶ç¾åœ¨æ´—æ¾¡
          await set(stateRef, { current: name });
        } else {
          // æœ‰äººæ´—æ¾¡ â†’ åŠ å…¥ queue
          await push(queueRef, { name, ts: Date.now() });
        }

        nameInput.value = "";
        nameInput.focus();
      } catch (e){
        console.error(e);
        alert("åŠ å…¥å¤±æ•—ï¼šå¯èƒ½æ˜¯ Firebase è¦å‰‡æ‹’çµ•ï¼ˆpermission deniedï¼‰æˆ–ç¶²è·¯å•é¡Œã€‚è«‹çœ‹ Consoleã€‚");
      }
    });

    // Call next
    nextBtn.addEventListener("click", async () => {
      try{
        // å– queue ç¬¬ä¸€å€‹
        const q = query(queueRef, orderByChild("ts"), limitToFirst(1));
        const snap = await get(q);

        if (!snap.exists()){
          // æ²’äººæ’éšŠ â†’ æ¸…ç©º current
          await set(stateRef, { current: "" });
          return;
        }

        // snap.val() æ˜¯ { key: {name, ts} }
        const firstKey = Object.keys(snap.val())[0];
        const firstObj = snap.val()[firstKey];
        const nextName = String(firstObj?.name || "").trim();

        // è¨­å®š current = nextNameï¼Œä¸¦æŠŠè©² queue item åˆªæ‰
        await set(stateRef, { current: nextName });
        await remove(ref(db, `queue/${firstKey}`));
      } catch (e){
        console.error(e);
        alert("å«ä¸‹ä¸€ä½å¤±æ•—ï¼šå¯èƒ½æ˜¯ Firebase è¦å‰‡æ‹’çµ•ï¼ˆpermission deniedï¼‰æˆ–ç¶²è·¯å•é¡Œã€‚è«‹çœ‹ Consoleã€‚");
      }
    });

    // Enter key = add
    nameInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") addBtn.click();
    });
  </script>
</body>
</html>
