<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ç‡ŸéšŠæ´—æ¾¡æ’éšŠç³»çµ±</title>

<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:linear-gradient(135deg,#dfe9f3,#ffffff);
  margin:0;
  padding:20px;
}

.container{
  max-width:520px;
  margin:auto;
}

.card{
  background:white;
  padding:18px;
  border-radius:18px;
  margin-bottom:18px;
  box-shadow:0 10px 25px rgba(0,0,0,0.08);
}

h1{
  text-align:center;
  margin:0;
  font-size:24px;
}

.status{
  font-size:20px;
  line-height:1.8;
}

.now{
  color:#2c7be5;
  font-weight:bold;
}

.next{
  color:#222;
  font-weight:bold;
}

/* ===== æº–å‚™æ´—æ¾¡å‹•ç•«å€ ===== */

.prepLine{
  margin-top:10px;
  padding:10px 14px;
  border-radius:14px;
  font-weight:900;
  background:rgba(229,83,83,0.1);
  border:1px solid rgba(229,83,83,0.3);
  display:inline-block;
}

.prepPulse{
  animation:prepPulse 1.2s ease-in-out 0s 2;
}

@keyframes prepPulse{
  0%{
    transform:translateY(0) scale(1);
    box-shadow:0 0 0 rgba(229,83,83,0);
  }
  40%{
    transform:translateY(-4px) scale(1.05);
    box-shadow:0 15px 30px rgba(229,83,83,0.25);
  }
  70%{
    transform:translateY(0) scale(1);
  }
  100%{
    transform:translateY(0) scale(1);
  }
}

/* ========================== */

input{
  width:65%;
  padding:12px;
  border-radius:12px;
  border:1px solid #ddd;
  font-size:16px;
}

button{
  padding:12px 16px;
  border-radius:12px;
  border:none;
  font-size:16px;
  cursor:pointer;
}

.join{
  background:#2c7be5;
  color:white;
}

.finish{
  width:100%;
  background:#222;
  color:white;
  margin-top:12px;
}

ul{
  padding-left:18px;
}

li{
  margin:6px 0;
}
</style>
</head>

<body>

<div class="container">

  <div class="card">
    <h1>ğŸš¿ ç‡ŸéšŠæ´—æ¾¡æ’éšŠç³»çµ±</h1>
  </div>

  <div class="card status">
    ç¾åœ¨æ´—æ¾¡ï¼š
    <span id="current" class="now">â€”</span><br>

    ä¸‹ä¸€ä½ï¼š
    <span id="next" class="next">â€”</span><br>

    <div id="prepLine" class="prepLine" style="display:none;">
      <span id="next2">â€”</span> æº–å‚™æ´—æ¾¡
    </div>
  </div>

  <div class="card">
    <input id="nameInput" placeholder="è¼¸å…¥åå­—">
    <button class="join" onclick="joinQueue()">åŠ å…¥æ’éšŠ</button>
    <button class="finish" onclick="nextPerson()">æˆ‘æ´—å¥½äº† â†’ å«ä¸‹ä¸€ä½</button>
  </div>

  <div class="card">
    <h3>æ’éšŠåå–®</h3>
    <ul id="queueList"></ul>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getDatabase, ref, set, push, remove, onValue }
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBSQAmMKvFjuANWhmZJAYHCwaIUTcwz6A8",
  authDomain: "jade-c8e32.firebaseapp.com",
  databaseURL: "https://jade-c8e32-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "jade-c8e32",
  storageBucket: "jade-c8e32.firebasestorage.app",
  messagingSenderId: "381125332620",
  appId: "1:381125332620:web:642dcf482b06fa3b9f35a9"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const currentEl = document.getElementById("current");
const nextEl = document.getElementById("next");
const next2El = document.getElementById("next2");
const prepLineEl = document.getElementById("prepLine");
const listEl = document.getElementById("queueList");

let lastPrepName = "";

// åŠ å…¥æ’éšŠ
window.joinQueue = function(){
  const name = document.getElementById("nameInput").value;
  if(!name) return;

  const currentRef = ref(db,"state/current");

  onValue(currentRef,(snap)=>{
    if(!snap.exists()){
      set(currentRef,name);
    }else{
      push(ref(db,"queue"),{name});
    }
  },{onlyOnce:true});

  document.getElementById("nameInput").value="";
}

// å«ä¸‹ä¸€ä½
window.nextPerson = function(){
  if(!confirm("ç¢ºå®šè¦å«ä¸‹ä¸€ä½å—ï¼Ÿ")) return;

  const queueRef = ref(db,"queue");

  onValue(queueRef,(snap)=>{
    const data = snap.val();
    if(!data){
      set(ref(db,"state/current"),null);
      return;
    }

    const keys = Object.keys(data);
    const firstKey = keys[0];
    const nextName = data[firstKey].name;

    set(ref(db,"state/current"),nextName);
    remove(ref(db,"queue/"+firstKey));
  },{onlyOnce:true});
}

// ç›£è½ current
onValue(ref(db,"state/current"),(snap)=>{
  currentEl.innerText = snap.exists()?snap.val():"â€”";
});

// ç›£è½ queue
onValue(ref(db,"queue"),(snap)=>{
  listEl.innerHTML="";
  const data = snap.val();

  if(!data){
    nextEl.innerText="â€”";
    prepLineEl.style.display="none";
    return;
  }

  const keys = Object.keys(data);
  const names = keys.map(k=>data[k].name);

  nextEl.innerText = names[0] || "â€”";

  // ç¬¬ä¸‰ä½é¡¯ç¤ºå‹•ç•«
  const prepName = names[1] || "";

  if(prepName){
    next2El.innerText = prepName;
    prepLineEl.style.display="inline-block";

    if(prepName !== lastPrepName){
      lastPrepName = prepName;
      prepLineEl.classList.remove("prepPulse");
      void prepLineEl.offsetWidth;
      prepLineEl.classList.add("prepPulse");
    }
  }else{
    prepLineEl.style.display="none";
    lastPrepName="";
  }

  names.forEach(name=>{
    const li=document.createElement("li");
    li.innerText=name;
    listEl.appendChild(li);
  });
});
</script>

</body>
</html>
