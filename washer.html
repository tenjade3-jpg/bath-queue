<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>æ´—è¡£æ©Ÿæ’éšŠç³»çµ±</title>

<style>
  body{
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;
    background: linear-gradient(135deg,#dfe9f3,#ffffff);
    margin:0; padding:20px; color:#111;
  }
  .container{ max-width:560px; margin:auto; }
  .card{
    background:#fff; padding:18px; border-radius:18px; margin-bottom:16px;
    box-shadow:0 10px 30px rgba(0,0,0,0.08);
  }
  h1{ text-align:center; font-size:24px; margin:0; }
  .sub{ text-align:center; opacity:.65; font-size:13px; margin:6px 0 0; }

  .status{ font-size:20px; line-height:1.8; }
  .now{ color:#2c7be5; font-weight:900; }
  .next{ color:#111; font-weight:900; }

  .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  input, select{
    flex:1; min-width:180px;
    padding:12px 12px; border-radius:12px; border:1px solid #ddd; font-size:16px; outline:none;
    background:#fff;
  }
  input:focus, select:focus{ border-color:#2c7be5; box-shadow:0 0 0 4px rgba(44,123,229,0.12); }
  button{
    padding:12px 14px; border-radius:12px; border:none; font-size:15px; cursor:pointer;
    white-space:nowrap; font-weight:900;
  }
  .join{ background:#2c7be5; color:#fff; }
  .finish{ width:100%; background:#111; color:#fff; margin-top:12px; }
  .ghost{ background:#f3f4f6; border:1px solid #e5e7eb; }
  .danger{ background:#e55353; color:#fff; }
  .hint{ font-size:13px; opacity:.7; margin-top:10px; }

  ul{ padding-left:18px; margin:10px 0 0; }
  li{ margin:6px 0; }

  /* ===== æº–å‚™æ´—è¡£å‹•ç•«å€ ===== */
  .prepLine{
    margin-top:10px;
    padding:10px 14px;
    border-radius:14px;
    font-weight:900;
    background:rgba(229,83,83,0.10);
    border:1px solid rgba(229,83,83,0.28);
    display:inline-block;
  }
  .prepPulse{ animation: prepPulse 1.2s ease-in-out 0s 2; }
  @keyframes prepPulse{
    0%{ transform:translateY(0) scale(1); box-shadow:0 0 0 rgba(229,83,83,0); }
    40%{ transform:translateY(-4px) scale(1.05); box-shadow:0 15px 30px rgba(229,83,83,0.25); }
    70%{ transform:translateY(0) scale(1); }
    100%{ transform:translateY(0) scale(1); box-shadow:0 0 0 rgba(229,83,83,0); }
  }
  /* ========================== */

  .backLink{
    display:inline-block;
    margin:0 0 12px;
    text-decoration:none;
    font-weight:900;
    color:#111;
    opacity:.8;
  }
  .backLink:hover{ opacity:1; }
</style>
</head>

<body>
<div class="container">

  <a class="backLink" href="index.html">â† å›é¦–é </a>

  <div class="card">
    <h1>ğŸ§º æ´—è¡£æ©Ÿæ’éšŠç³»çµ±</h1>
    <p class="sub">ï¼ˆå¤šäººå³æ™‚åŒæ­¥ / rooms ç‰ˆï¼‰</p>
  </div>

  <!-- æ©Ÿå°é¸æ“‡ -->
  <div class="card">
    <div class="row">
      <select id="roomSelect"></select>
      <button class="ghost" id="refreshRoomsBtn">é‡æ–°æ•´ç†</button>
    </div>
    <div class="hint" id="roomHint">è¼‰å…¥æ©Ÿå°ä¸­â€¦</div>
  </div>

  <div class="card status">
    ç›®å‰ä½¿ç”¨ï¼š <span id="current" class="now">â€”</span><br>
    ä¸‹ä¸€ä½ï¼š <span id="next" class="next">â€”</span><br>

    <div id="prepLine" class="prepLine" style="display:none;">
      <span id="next2">â€”</span> æº–å‚™æ´—è¡£
    </div>
  </div>

  <div class="card">
    <div class="row">
      <input id="nameInput" placeholder="è¼¸å…¥åå­—" maxlength="20">
      <button class="join" id="joinBtn">åŠ å…¥æ’éšŠ</button>
    </div>

    <button class="finish" id="doneBtn">æˆ‘æ´—å¥½äº† â†’ å«ä¸‹ä¸€ä½</button>
    <div class="hint">ï¼ˆæœƒè·³å‡ºç¢ºèªè¦–çª— + æ’­æ”¾æç¤ºéŸ³ï¼‰</div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px;">æ’éšŠåå–®</h3>
    <div id="queueEmpty" style="opacity:.6;">ï¼ˆç›®å‰æ²’æœ‰äººæ’éšŠï¼‰</div>
    <ul id="queueList"></ul>
  </div>

  <audio id="beep" preload="auto"
    src="data:audio/wav;base64,UklGRlQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQwAAAAA/////wAAAP////8AAAD/////AAAA/////wAAAP////8AAAD/////AAAA/////wAAAP////8="></audio>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import {
  getDatabase, ref, set, push, remove, onValue, get, query, orderByChild, limitToFirst
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBSQAmMKvFjuANWhmZJAYHCwaIUTcwz6A8",
  authDomain: "jade-c8e32.firebaseapp.com",
  databaseURL: "https://jade-c8e32-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "jade-c8e32",
  storageBucket: "jade-c8e32.firebasestorage.app",
  messagingSenderId: "381125332620",
  appId: "1:381125332620:web:642dcf482b06fa3b9f35a9"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/** -------- UI refs -------- */
const roomSelect = document.getElementById("roomSelect");
const roomHint = document.getElementById("roomHint");

const currentEl = document.getElementById("current");
const nextEl = document.getElementById("next");
const next2El = document.getElementById("next2");
const prepLineEl = document.getElementById("prepLine");
const listEl = document.getElementById("queueList");
const emptyEl = document.getElementById("queueEmpty");
const nameInput = document.getElementById("nameInput");

let roomMap = {};     // {roomId:{name}}
let roomId = "";      // selected
let queueCache = [];  // [{key,name,ts}]
let lastPrepName = "";

// unsubscribers
let unsubRooms = null;
let unsubCurrent = null;
let unsubQueue = null;

function playBeep(){
  const a = document.getElementById("beep");
  if(!a) return;
  a.currentTime = 0;
  const p = a.play();
  if(p && p.catch) p.catch(()=>{});
}

function detachRoomListeners(){
  if(unsubCurrent) unsubCurrent();
  if(unsubQueue) unsubQueue();
  unsubCurrent = null;
  unsubQueue = null;
}

function stateCurrentRef(){
  return ref(db, `queues/washer/rooms/${roomId}/state/current`);
}
function queueRef(){
  return ref(db, `queues/washer/rooms/${roomId}/queue`);
}
function roomsRef(){
  return ref(db, `queues/washer/rooms`);
}

/** ---- render helpers ---- */
function updateNextLines(){
  nextEl.innerText = queueCache[0]?.name || "â€”";

  const prepName = queueCache[1]?.name || "";
  if(prepName){
    next2El.innerText = prepName;
    prepLineEl.style.display = "inline-block";

    if(prepName !== lastPrepName){
      lastPrepName = prepName;
      prepLineEl.classList.remove("prepPulse");
      void prepLineEl.offsetWidth;
      prepLineEl.classList.add("prepPulse");
    }
  }else{
    prepLineEl.style.display = "none";
    lastPrepName = "";
  }
}

function renderQueueList(){
  listEl.innerHTML = "";
  if(queueCache.length === 0){
    emptyEl.style.display = "block";
  }else{
    emptyEl.style.display = "none";
    queueCache.forEach(q=>{
      const li = document.createElement("li");
      li.textContent = q.name;
      listEl.appendChild(li);
    });
  }
}

function renderRooms(){
  roomSelect.innerHTML = "";
  const entries = Object.entries(roomMap || {});
  if(entries.length === 0){
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "ï¼ˆç›®å‰æ²’æœ‰æ©Ÿå°ï¼‰";
    roomSelect.appendChild(opt);
    roomId = "";
    roomHint.textContent = "ç›®å‰æ²’æœ‰æ©Ÿå°ï¼Œè«‹ç®¡ç†å“¡åˆ° admin.html æ–°å¢æ´—è¡£æ©Ÿã€‚";
    return;
  }

  entries.sort((a,b)=> String(a[1]?.name||"").localeCompare(String(b[1]?.name||""), "zh-Hant"));

  if(!roomId || !roomMap[roomId]) roomId = entries[0][0];

  for(const [id, v] of entries){
    const opt = document.createElement("option");
    opt.value = id;
    opt.textContent = v?.name ? v.name : id;
    opt.selected = (id === roomId);
    roomSelect.appendChild(opt);
  }

  const selectedName = roomMap?.[roomId]?.name || roomId;
  roomHint.textContent = `ç›®å‰é¸æ“‡ï¼š${selectedName}`;
}

function attachRoomListeners(){
  detachRoomListeners();
  if(!roomId) return;

  unsubCurrent = onValue(stateCurrentRef(), (snap)=>{
    currentEl.innerText = (snap.exists() && snap.val()) ? snap.val() : "â€”";
  });

  unsubQueue = onValue(queueRef(), (snap)=>{
    const data = snap.val() || {};
    const arr = Object.entries(data).map(([key, v]) => ({
      key,
      name: v?.name ?? "",
      ts: v?.ts ?? 0
    })).filter(x => String(x.name).trim());

    arr.sort((a,b)=>a.ts-b.ts);
    queueCache = arr;

    renderQueueList();
    updateNextLines();
  });
}

function loadRooms(){
  if(unsubRooms) unsubRooms();
  roomHint.textContent = "è¼‰å…¥æ©Ÿå°ä¸­â€¦";

  unsubRooms = onValue(roomsRef(), (snap)=>{
    roomMap = snap.val() || {};
    renderRooms();
    attachRoomListeners();
  });
}

roomSelect.addEventListener("change", ()=>{
  roomId = roomSelect.value;
  renderRooms();
  attachRoomListeners();
});

document.getElementById("refreshRoomsBtn").addEventListener("click", loadRooms);

/** ---- actions ---- */
document.getElementById("joinBtn").addEventListener("click", async ()=>{
  if(!roomId) return alert("ç›®å‰æ²’æœ‰æ©Ÿå°å¯é¸ï¼Œè«‹å…ˆè«‹ç®¡ç†å“¡æ–°å¢ã€‚");

  const name = String(nameInput.value || "").trim();
  if(!name) return alert("è«‹è¼¸å…¥åå­—");

  const curSnap = await get(stateCurrentRef());
  const cur = (curSnap.exists() ? String(curSnap.val() || "") : "").trim();

  if(!cur){
    await set(stateCurrentRef(), name);
  }else{
    await push(queueRef(), { name, ts: Date.now() });
  }
  nameInput.value = "";
});

document.getElementById("doneBtn").addEventListener("click", async ()=>{
  if(!roomId) return alert("ç›®å‰æ²’æœ‰æ©Ÿå°å¯é¸ï¼Œè«‹å…ˆè«‹ç®¡ç†å“¡æ–°å¢ã€‚");
  if(!confirm("ç¢ºå®šä½ æ´—å¥½äº†ï¼Œè¦å«ä¸‹ä¸€ä½å—ï¼Ÿ")) return;

  const q = query(queueRef(), orderByChild("ts"), limitToFirst(1));
  const snap = await get(q);

  if(!snap.exists()){
    await set(stateCurrentRef(), null);
    playBeep();
    return;
  }

  const firstKey = Object.keys(snap.val())[0];
  const nextName = snap.val()[firstKey]?.name || "";

  await set(stateCurrentRef(), nextName);
  await remove(ref(db, `queues/washer/rooms/${roomId}/queue/${firstKey}`));
  playBeep();
});

/** init */
loadRooms();
</script>

</body>
</html>
