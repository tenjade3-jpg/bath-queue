<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>æ´—è¡£æ©Ÿæ’éšŠç³»çµ±</title>

<style>
  body{
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;
    background: linear-gradient(135deg,#dfe9f3,#ffffff);
    margin:0; padding:20px; color:#111;
  }
  .container{ max-width:560px; margin:auto; }
  .card{
    background:#fff; padding:18px; border-radius:18px; margin-bottom:16px;
    box-shadow:0 10px 30px rgba(0,0,0,0.08);
  }
  h1{ text-align:center; font-size:24px; margin:0; }
  .sub{ text-align:center; opacity:.65; font-size:13px; margin:6px 0 0; }

  .status{ font-size:20px; line-height:1.8; }
  .now{ color:#2c7be5; font-weight:900; }
  .next{ color:#111; font-weight:900; }

  .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  input{
    flex:1; min-width:180px;
    padding:12px 12px; border-radius:12px; border:1px solid #ddd; font-size:16px; outline:none;
  }
  input:focus{ border-color:#2c7be5; box-shadow:0 0 0 4px rgba(44,123,229,0.12); }
  button{
    padding:12px 14px; border-radius:12px; border:none; font-size:15px; cursor:pointer;
    white-space:nowrap; font-weight:900;
  }
  .join{ background:#2c7be5; color:#fff; }
  .finish{ width:100%; background:#111; color:#fff; margin-top:12px; }
  .ghost{ background:#f3f4f6; border:1px solid #e5e7eb; }
  .danger{ background:#e55353; color:#fff; }
  .hint{ font-size:13px; opacity:.7; margin-top:10px; }

  ul{ padding-left:18px; margin:10px 0 0; }
  li{ margin:6px 0; }

  /* ===== æº–å‚™æ´—è¡£å‹•ç•«å€ ===== */
  .prepLine{
    margin-top:10px;
    padding:10px 14px;
    border-radius:14px;
    font-weight:900;
    background:rgba(229,83,83,0.10);
    border:1px solid rgba(229,83,83,0.28);
    display:inline-block;
  }
  .prepPulse{ animation: prepPulse 1.2s ease-in-out 0s 2; }
  @keyframes prepPulse{
    0%{ transform:translateY(0) scale(1); box-shadow:0 0 0 rgba(229,83,83,0); }
    40%{ transform:translateY(-4px) scale(1.05); box-shadow:0 15px 30px rgba(229,83,83,0.25); }
    70%{ transform:translateY(0) scale(1); }
    100%{ transform:translateY(0) scale(1); box-shadow:0 0 0 rgba(229,83,83,0); }
  }
  /* ========================== */

  .pill{
    display:inline-block;
    font-size:12px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid #ddd;
    color:#666;
  }
  .adminTop{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
  }
  .adminPanel{ display:none; margin-top:12px; }
  .adminPanel.show{ display:block; }

  .qitem{
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:space-between;
    padding:10px 12px;
    border:1px solid #eee;
    border-radius:14px;
    margin-top:10px;
    background:#fff;
  }
  .qname{ font-weight:900; }
  .qtools{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
  .mini{ padding:8px 10px; border-radius:10px; font-size:13px; font-weight:900; border:0; cursor:pointer; }
  .miniUpDown{ background:#f3f4f6; border:1px solid #e5e7eb; }
  .miniDel{ background:#111; color:#fff; }
  .miniNow{ background:#2c7be5; color:#fff; }

  .backLink{
    display:inline-block;
    margin:0 0 12px;
    text-decoration:none;
    font-weight:900;
    color:#111;
    opacity:.8;
  }
  .backLink:hover{ opacity:1; }
</style>
</head>

<body>
<div class="container">

  <a class="backLink" href="index.html">â† å›é¦–é </a>

  <div class="card">
    <h1>ğŸ§º æ´—è¡£æ©Ÿæ’éšŠç³»çµ±</h1>
    <p class="sub">ï¼ˆå¤šäººå³æ™‚åŒæ­¥ï¼‰</p>
  </div>

  <div class="card status">
    ç›®å‰ä½¿ç”¨ï¼š <span id="current" class="now">â€”</span><br>
    ä¸‹ä¸€ä½ï¼š <span id="next" class="next">â€”</span><br>

    <div id="prepLine" class="prepLine" style="display:none;">
      <span id="next2">â€”</span> æº–å‚™æ´—è¡£
    </div>
  </div>

  <div class="card">
    <div class="row">
      <input id="nameInput" placeholder="è¼¸å…¥åå­—" maxlength="20">
      <button class="join" id="joinBtn">åŠ å…¥æ’éšŠ</button>
    </div>

    <button class="finish" id="doneBtn">æˆ‘æ´—å¥½äº† â†’ å«ä¸‹ä¸€ä½</button>
    <div class="hint">ï¼ˆæœƒè·³å‡ºç¢ºèªè¦–çª— + æ’­æ”¾æç¤ºéŸ³ï¼‰</div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px;">æ’éšŠåå–®</h3>
    <div id="queueEmpty" style="opacity:.6;">ï¼ˆç›®å‰æ²’æœ‰äººæ’éšŠï¼‰</div>
    <ul id="queueList"></ul>
  </div>

  <!-- å·¥ä½œäººå“¡ -->
  <div class="card">
    <div class="adminTop">
      <div class="pill">ğŸ›  å·¥ä½œäººå“¡æ§åˆ¶</div>
      <button class="ghost" id="adminToggleBtn">å·¥ä½œäººå“¡ç™»å…¥ / é€€å‡º</button>
    </div>

    <div id="adminPanel" class="adminPanel">
      <div class="hint">ç®¡ç†å“¡å¯èª¿æ•´é †åº / åˆªé™¤ / è¨­ç‚ºç›®å‰ä½¿ç”¨</div>

      <div class="row" style="margin-top:10px">
        <input id="adminAddName" placeholder="ç®¡ç†å“¡æ–°å¢ï¼šè¼¸å…¥åå­—" maxlength="20">
        <button class="ghost" id="adminAddBtn">æ–°å¢åˆ°éšŠä¼</button>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="ghost" id="adminClearCurrentBtn" style="flex:1">æ¸…ç©ºã€Œç›®å‰ä½¿ç”¨ã€</button>
        <button class="danger" id="adminClearQueueBtn" style="flex:1">æ¸…ç©ºæ•´å€‹éšŠä¼</button>
      </div>

      <div id="adminQueueBox"></div>
    </div>
  </div>

  <audio id="beep" preload="auto"
    src="data:audio/wav;base64,UklGRlQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQwAAAAA/////wAAAP////8AAAD/////AAAA/////wAAAP////8AAAD/////AAAA/////wAAAP////8="></audio>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import {
  getDatabase, ref, set, push, remove, onValue, get, query, orderByChild, limitToFirst
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

/* ===== ä½ æ”¹é€™è£¡ï¼šç®¡ç†å“¡å¯†ç¢¼ï¼ˆå…©é å¯ä»¥ç”¨åŒä¸€å€‹ï¼‰===== */
const ADMIN_PASSWORD = "1234";
/* ======================================================= */

const firebaseConfig = {
  apiKey: "AIzaSyBSQAmMKvFjuANWhmZJAYHCwaIUTcwz6A8",
  authDomain: "jade-c8e32.firebaseapp.com",
  databaseURL: "https://jade-c8e32-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "jade-c8e32",
  storageBucket: "jade-c8e32.firebasestorage.app",
  messagingSenderId: "381125332620",
  appId: "1:381125332620:web:642dcf482b06fa3b9f35a9"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* âœ… v3 å¤šä½‡åˆ—ï¼šæ´—è¡£æ©Ÿç‰ˆè·¯å¾‘ */
const stateCurrentRef = ref(db, "queues/washer/state/current");   // string | null
const queueRef = ref(db, "queues/washer/queue");                  // push list {name, ts}

const currentEl = document.getElementById("current");
const nextEl = document.getElementById("next");
const next2El = document.getElementById("next2");
const prepLineEl = document.getElementById("prepLine");
const listEl = document.getElementById("queueList");
const emptyEl = document.getElementById("queueEmpty");

const adminPanel = document.getElementById("adminPanel");
const adminQueueBox = document.getElementById("adminQueueBox");
const nameInput = document.getElementById("nameInput");

let isAdmin = false;
let queueCache = []; // [{key, name, ts}]
let lastPrepName = "";

// ---- éŸ³æ•ˆï¼ˆiPad æœ€ç©©ï¼šaudioï¼‰----
function playBeep(){
  const a = document.getElementById("beep");
  if(!a) return;
  a.currentTime = 0;
  const p = a.play();
  if(p && p.catch) p.catch(()=>{});
}

// ---- æ›´æ–°é¡¯ç¤ºï¼ˆnext / next2 + å‹•ç•«ï¼‰----
function updateNextLines(){
  nextEl.innerText = queueCache[0]?.name || "â€”";

  const prepName = queueCache[1]?.name || "";
  if(prepName){
    next2El.innerText = prepName;
    prepLineEl.style.display = "inline-block";

    if(prepName !== lastPrepName){
      lastPrepName = prepName;
      prepLineEl.classList.remove("prepPulse");
      void prepLineEl.offsetWidth;
      prepLineEl.classList.add("prepPulse");
    }
  }else{
    prepLineEl.style.display = "none";
    lastPrepName = "";
  }
}

// ---- ä¸€èˆ¬åå–® render ----
function renderQueueList(){
  listEl.innerHTML = "";
  if(queueCache.length === 0){
    emptyEl.style.display = "block";
  }else{
    emptyEl.style.display = "none";
    queueCache.forEach(q=>{
      const li = document.createElement("li");
      li.textContent = q.name;
      listEl.appendChild(li);
    });
  }
}

// ---- ç®¡ç†å“¡éšŠä¼æ§åˆ¶ render ----
function renderAdminQueue(){
  adminQueueBox.innerHTML = "";
  if(!isAdmin) return;

  queueCache.forEach((q, idx)=>{
    const row = document.createElement("div");
    row.className = "qitem";
    row.innerHTML = `
      <div class="qname">${idx+1}. ${q.name}</div>
      <div class="qtools">
        <button class="mini miniNow" data-act="now" data-key="${q.key}">è¨­ç‚ºç›®å‰</button>
        <button class="mini miniUpDown" data-act="up" data-key="${q.key}">â†‘</button>
        <button class="mini miniUpDown" data-act="down" data-key="${q.key}">â†“</button>
        <button class="mini miniDel" data-act="del" data-key="${q.key}">åˆª</button>
      </div>
    `;
    adminQueueBox.appendChild(row);
  });
}

// ---- ç›£è½ current ----
onValue(stateCurrentRef, (snap)=>{
  currentEl.innerText = (snap.exists() && snap.val()) ? snap.val() : "â€”";
});

// ---- ç›£è½ queueï¼ˆç”¨ ts æ’åºï¼‰----
onValue(queueRef, (snap)=>{
  const data = snap.val() || {};
  const arr = Object.entries(data).map(([key, v]) => ({
    key,
    name: v?.name ?? "",
    ts: v?.ts ?? 0
  })).filter(x => String(x.name).trim());

  arr.sort((a,b)=>a.ts-b.ts);
  queueCache = arr;

  renderQueueList();
  updateNextLines();
  renderAdminQueue();
});

// ---- åŠ å…¥æ’éšŠï¼šè‹¥ current ç©º -> ç›´æ¥ç•¶ currentï¼›ä¸ç„¶ push queue ----
document.getElementById("joinBtn").addEventListener("click", async ()=>{
  const name = String(nameInput.value || "").trim();
  if(!name) return alert("è«‹è¼¸å…¥åå­—");

  const curSnap = await get(stateCurrentRef);
  const cur = (curSnap.exists() ? String(curSnap.val() || "") : "").trim();

  if(!cur){
    await set(stateCurrentRef, name);
  }else{
    await push(queueRef, { name, ts: Date.now() });
  }
  nameInput.value = "";
});

// ---- å«ä¸‹ä¸€ä½ï¼ˆç¢ºèª + éŸ³æ•ˆï¼‰----
document.getElementById("doneBtn").addEventListener("click", async ()=>{
  if(!confirm("ç¢ºå®šä½ æ´—å¥½äº†ï¼Œè¦å«ä¸‹ä¸€ä½å—ï¼Ÿ")) return;

  // å– queue ç¬¬ä¸€å€‹ï¼ˆç”¨ tsï¼‰
  const q = query(queueRef, orderByChild("ts"), limitToFirst(1));
  const snap = await get(q);

  if(!snap.exists()){
    await set(stateCurrentRef, null);
    playBeep();
    return;
  }

  const firstKey = Object.keys(snap.val())[0];
  const nextName = snap.val()[firstKey]?.name || "";

  await set(stateCurrentRef, nextName);
  await remove(ref(db, `queues/washer/queue/${firstKey}`));
  playBeep();
});

// ---- ç®¡ç†å“¡ç™»å…¥/é€€å‡º ----
document.getElementById("adminToggleBtn").addEventListener("click", ()=>{
  if(!isAdmin){
    const pw = prompt("è¼¸å…¥å·¥ä½œäººå“¡å¯†ç¢¼ï¼š");
    if(pw === null) return;
    if(pw !== ADMIN_PASSWORD) return alert("å¯†ç¢¼éŒ¯èª¤");
    isAdmin = true;
    adminPanel.classList.add("show");
    renderAdminQueue();
    alert("å·¥ä½œäººå“¡æ¨¡å¼å·²é–‹å•Ÿ âœ…");
  }else{
    isAdmin = false;
    adminPanel.classList.remove("show");
    adminQueueBox.innerHTML = "";
    alert("å·²é€€å‡ºå·¥ä½œäººå“¡æ¨¡å¼");
  }
});

// ---- ç®¡ç†å“¡æ–°å¢åˆ°éšŠä¼ ----
document.getElementById("adminAddBtn").addEventListener("click", async ()=>{
  if(!isAdmin) return alert("è«‹å…ˆç™»å…¥å·¥ä½œäººå“¡æ¨¡å¼");
  const name = String(document.getElementById("adminAddName").value || "").trim();
  if(!name) return;
  await push(queueRef, { name, ts: Date.now() });
  document.getElementById("adminAddName").value = "";
});

// ---- ç®¡ç†å“¡æ¸…ç©º current ----
document.getElementById("adminClearCurrentBtn").addEventListener("click", async ()=>{
  if(!isAdmin) return alert("è«‹å…ˆç™»å…¥å·¥ä½œäººå“¡æ¨¡å¼");
  if(!confirm("ç¢ºå®šæ¸…ç©ºã€Œç›®å‰ä½¿ç”¨ã€ï¼Ÿ")) return;
  await set(stateCurrentRef, null);
});

// ---- ç®¡ç†å“¡æ¸…ç©º queue ----
document.getElementById("adminClearQueueBtn").addEventListener("click", async ()=>{
  if(!isAdmin) return alert("è«‹å…ˆç™»å…¥å·¥ä½œäººå“¡æ¨¡å¼");
  if(!confirm("ç¢ºå®šæ¸…ç©ºæ•´å€‹éšŠä¼ï¼Ÿ")) return;
  await set(queueRef, null);
});

// ---- ç®¡ç†å“¡ï¼šä¸Š/ä¸‹ç§» é‡å¯« ts ----
async function rewriteQueueOrderFromCache(){
  const base = Date.now();
  const obj = {};
  queueCache.forEach((q,i)=>{ obj[q.key] = { name:q.name, ts: base+i }; });
  await set(queueRef, Object.keys(obj).length ? obj : null);
}

// ---- ç®¡ç†å“¡éšŠä¼æ“ä½œ ----
adminQueueBox.addEventListener("click", async (e)=>{
  const btn = e.target.closest("button");
  if(!btn) return;
  if(!isAdmin) return alert("è«‹å…ˆç™»å…¥å·¥ä½œäººå“¡æ¨¡å¼");

  const act = btn.dataset.act;
  const key = btn.dataset.key;
  const idx = queueCache.findIndex(x=>x.key===key);
  if(idx < 0) return;

  if(act==="del"){
    if(!confirm("ç¢ºå®šç§»é™¤ï¼Ÿ")) return;
    await remove(ref(db, `queues/washer/queue/${key}`));
    return;
  }

  if(act==="now"){
    const name = queueCache[idx].name;
    if(!confirm(`ç¢ºå®šè¨­ã€Œ${name}ã€ç‚ºç›®å‰ä½¿ç”¨ï¼Ÿï¼ˆä¸¦å¾éšŠä¼ç§»é™¤ï¼‰`)) return;
    await set(stateCurrentRef, name);
    await remove(ref(db, `queues/washer/queue/${key}`));
    playBeep();
    return;
  }

  if(act==="up" && idx>0){
    [queueCache[idx-1], queueCache[idx]] = [queueCache[idx], queueCache[idx-1]];
    await rewriteQueueOrderFromCache();
    return;
  }

  if(act==="down" && idx<queueCache.length-1){
    [queueCache[idx+1], queueCache[idx]] = [queueCache[idx], queueCache[idx+1]];
    await rewriteQueueOrderFromCache();
    return;
  }
});
</script>

</body>
</html>
