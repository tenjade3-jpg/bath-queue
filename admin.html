<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ç®¡ç†å“¡ä»‹é¢</title>

<style>
  body{
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;
    background: linear-gradient(135deg,#dfe9f3,#ffffff);
    margin:0; padding:20px; color:#111;
  }
  .container{ max-width:980px; margin:auto; }
  .card{
    background:#fff; padding:18px; border-radius:18px; margin-bottom:16px;
    box-shadow:0 10px 30px rgba(0,0,0,0.08);
  }
  h1{ margin:0; font-size:22px; }
  .sub{ opacity:.65; font-size:13px; margin:6px 0 0; }
  .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

  input, select{
    padding:12px 12px; border-radius:12px; border:1px solid #ddd; font-size:16px; outline:none;
    min-width:220px; background:#fff;
  }
  input:focus, select:focus{ border-color:#2c7be5; box-shadow:0 0 0 4px rgba(44,123,229,0.12); }

  button{
    padding:12px 14px; border-radius:12px; border:none; font-size:15px; cursor:pointer;
    white-space:nowrap; font-weight:900;
  }
  .primary{ background:#2c7be5; color:#fff; }
  .ghost{ background:#f3f4f6; border:1px solid #e5e7eb; }
  .danger{ background:#e55353; color:#fff; }

  .pill{
    display:inline-block; font-size:12px; padding:6px 10px; border-radius:999px;
    border:1px solid #ddd; color:#666;
  }

  .tabs{ display:flex; gap:10px; }
  .tab{
    padding:10px 14px; border-radius:999px; border:1px solid #ddd; background:#fff; cursor:pointer; font-weight:900;
  }
  .tab.active{ background:#111; color:#fff; border-color:#111; }

  .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
  @media (max-width:900px){ .grid{ grid-template-columns:1fr; } }

  .status{ font-size:18px; line-height:1.8; }
  .now{ color:#2c7be5; font-weight:900; }
  .next{ color:#111; font-weight:900; }

  .qitem{
    display:flex; gap:10px; align-items:center; justify-content:space-between;
    padding:10px 12px; border:1px solid #eee; border-radius:14px; margin-top:10px; background:#fff;
  }
  .qname{ font-weight:900; }
  .qtools{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
  .mini{ padding:8px 10px; border-radius:10px; font-size:13px; font-weight:900; border:0; cursor:pointer; }
  .miniUpDown{ background:#f3f4f6; border:1px solid #e5e7eb; }
  .miniDel{ background:#111; color:#fff; }
  .miniNow{ background:#2c7be5; color:#fff; }

  .hint{ font-size:13px; opacity:.7; margin-top:8px; }

  .loginMask{
    position:fixed; inset:0; background:rgba(0,0,0,.35);
    display:flex; align-items:center; justify-content:center; padding:20px;
  }
  .loginBox{
    background:#fff; border-radius:18px; padding:18px; max-width:420px; width:100%;
    box-shadow:0 10px 40px rgba(0,0,0,.2);
  }

  .topRight{ display:flex; gap:10px; align-items:center; justify-content:flex-end; flex-wrap:wrap; }
  a.link{ text-decoration:none; font-weight:900; color:#111; opacity:.8; }
  a.link:hover{ opacity:1; }

  .sectionTitle{ font-weight:900; margin:0 0 8px; }
</style>
</head>

<body>
<div class="container">

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div>
        <h1>ğŸ›  ç®¡ç†å“¡ä»‹é¢</h1>
        <div class="sub">rooms ç®¡ç† + éšŠä¼èª¿åº¦ +ï¼ˆæ´—æ¾¡ï¼‰é–‹å§‹æ™‚é–“/æš«åœæ§åˆ¶</div>
      </div>
      <div class="topRight">
        <span class="pill" id="loginState">æœªç™»å…¥</span>
        <button class="ghost" id="logoutBtn" style="display:none;">ç™»å‡º</button>
        <a class="link" href="index.html">â† å›é¦–é </a>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="tabs">
      <button class="tab active" id="tabShower">ğŸš¿ æ´—æ¾¡</button>
      <button class="tab" id="tabWasher">ğŸ§º æ´—è¡£</button>
    </div>
  </div>

  <div class="grid">

    <!-- å·¦ï¼šæˆ¿é–“ç®¡ç† -->
    <div class="card">
      <div class="pill">æˆ¿é–“ / æ©Ÿå°ç®¡ç†</div>
      <div class="hint">æ–°å¢ã€åˆªé™¤ï¼Œä¸¦é¸æ“‡è¦èª¿åº¦çš„æˆ¿é–“</div>

      <div class="row" style="margin-top:10px">
        <select id="roomSelect"></select>
        <button class="ghost" id="refreshRoomsBtn">é‡æ–°æ•´ç†</button>
      </div>

      <div class="row" style="margin-top:10px">
        <input id="newRoomName" placeholder="æ–°å¢åç¨±ï¼ˆä¾‹ï¼šæ·‹æµ´é–“ A / æ´—è¡£æ©Ÿ 1ï¼‰" maxlength="30">
        <button class="primary" id="addRoomBtn">æ–°å¢</button>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="danger" id="deleteRoomBtn" style="flex:1">åˆªé™¤é¸å–æˆ¿é–“ï¼ˆå«éšŠä¼ï¼‰</button>
      </div>

      <div class="hint" id="roomHint" style="margin-top:12px;">è¼‰å…¥ä¸­â€¦</div>
    </div>

    <!-- å³ï¼šèª¿åº¦ +ï¼ˆæ´—æ¾¡ï¼‰æ§åˆ¶ -->
    <div class="card">
      <div class="pill">èª¿åº¦é¢æ¿</div>

      <div class="card status" style="margin-top:12px">
        ç¾åœ¨ä½¿ç”¨ï¼š <span id="current" class="now">â€”</span><br>
        ä¸‹ä¸€ä½ï¼š <span id="next" class="next">â€”</span><br>
        ç¬¬ä¸‰ä½ï¼š <span id="third" class="next">â€”</span>
      </div>

      <!-- âœ… ç®¡ç†å“¡åŠ å…¥æ’éšŠï¼ˆä½ è¦çš„ï¼šå›ä¾†äº†ï¼‰ -->
      <div class="row" style="margin-top:10px">
        <input id="adminAddName" placeholder="ç®¡ç†å“¡åŠ å…¥æ’éšŠï¼šè¼¸å…¥åå­—" maxlength="20">
        <button class="ghost" id="adminAddBtn">åŠ å…¥éšŠä¼</button>
      </div>

      <!-- âœ… æ´—æ¾¡å°ˆç”¨ï¼šé–‹å§‹æ™‚é–“/æš«åœ -->
      <div id="showerControlPanel" style="margin-top:12px; display:none;">
        <div class="sectionTitle">â± æ´—æ¾¡æ§åˆ¶ï¼ˆæ¯äºº 15 åˆ†é˜ï¼‰</div>

        <div class="row">
          <input id="plannedTimeInput" type="time">
          <button class="ghost" id="setPlannedBtn">è¨­å®šå¯é–‹å§‹æ™‚é–“</button>
        </div>
        <div class="hint" id="plannedHint">å¯é–‹å§‹æ™‚é–“ï¼šâ€”</div>

        <div class="row" style="margin-top:10px">
          <button class="danger" id="pauseAllBtn" style="flex:1">æš«åœï¼ˆé–ä½é–‹å§‹ï¼‰</button>
          <button class="ghost" id="resumeAllBtn" style="flex:1">è§£é™¤æš«åœ</button>
        </div>
        <div class="hint" id="pauseHint">ç‹€æ…‹ï¼šâ€”</div>

        <div class="row" style="margin-top:10px">
          <button class="danger" id="resetTimerBtn" style="flex:1">é‡è¨­è¨ˆæ™‚ï¼ˆä¸‹ä¸€ä½é‡æ–°æŒ‰é–‹å§‹ï¼‰</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="ghost" id="clearCurrentBtn" style="flex:1">æ¸…ç©º current</button>
        <button class="danger" id="clearQueueBtn" style="flex:1">æ¸…ç©º queue</button>
      </div>

      <div class="hint">æ’åº/è¨­ç‚ºç¾åœ¨/åˆªé™¤åœ¨ä¸‹é¢éšŠä¼æ“ä½œã€‚</div>
      <div id="adminQueueBox"></div>
    </div>

  </div>

</div>

<!-- ç™»å…¥é®ç½© -->
<div class="loginMask" id="loginMask">
  <div class="loginBox">
    <h2 style="margin:0 0 8px;">ç®¡ç†å“¡ç™»å…¥</h2>
    <div class="sub" style="margin-bottom:12px;">è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼</div>

    <div class="row">
      <input id="pwInput" type="password" placeholder="è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼">
      <button class="primary" id="loginBtn">ç™»å…¥</button>
    </div>

    <div class="hint">ï¼ˆç™»å…¥ç‹€æ…‹æœƒä¿å­˜åœ¨æ­¤ç€è¦½å™¨ï¼‰</div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getDatabase, ref, set, push, remove, onValue } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

const ADMIN_PASSWORD = "g8g8";
const LS_KEY = "camp_admin_ok";
const DURATION_MS = 15 * 60 * 1000;

const firebaseConfig = {
  apiKey: "AIzaSyBSQAmMKvFjuANWhmZJAYHCwaIUTcwz6A8",
  authDomain: "jade-c8e32.firebaseapp.com",
  databaseURL: "https://jade-c8e32-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "jade-c8e32",
  storageBucket: "jade-c8e32.firebasestorage.app",
  messagingSenderId: "381125332620",
  appId: "1:381125332620:web:642dcf482b06fa3b9f35a9"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/** ===== ç™»å…¥æ§åˆ¶ï¼ˆä¸è‡ªå‹•ç™»å‡ºï¼‰===== */
const loginMask = document.getElementById("loginMask");
const loginState = document.getElementById("loginState");
const logoutBtn = document.getElementById("logoutBtn");
const pwInput = document.getElementById("pwInput");
const loginBtn = document.getElementById("loginBtn");

function isLoggedIn(){ return localStorage.getItem(LS_KEY) === "1"; }
function applyLoginUI(){
  const ok = isLoggedIn();
  loginMask.style.display = ok ? "none" : "flex";
  loginState.textContent = ok ? "å·²ç™»å…¥" : "æœªç™»å…¥";
  logoutBtn.style.display = ok ? "inline-block" : "none";
}
applyLoginUI();

loginBtn.addEventListener("click", ()=>{
  if(String(pwInput.value || "") !== ADMIN_PASSWORD){ alert("ç™»å…¥å¤±æ•—"); return; }
  localStorage.setItem(LS_KEY, "1");
  pwInput.value = "";
  applyLoginUI();
});
pwInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") loginBtn.click(); });
logoutBtn.addEventListener("click", ()=>{ localStorage.removeItem(LS_KEY); applyLoginUI(); });

/** ===== rooms + èª¿åº¦ ===== */
let mode = "shower";
let roomId = "";
let roomMap = {};
let queueCache = [];

let unsubRooms=null, unsubCurrent=null, unsubQueue=null, unsubControl=null;

let controlPlannedStartAt = null;
let controlIsPaused = false;

const tabShower = document.getElementById("tabShower");
const tabWasher = document.getElementById("tabWasher");
const roomSelect = document.getElementById("roomSelect");
const roomHint = document.getElementById("roomHint");

const currentEl = document.getElementById("current");
const nextEl = document.getElementById("next");
const thirdEl = document.getElementById("third");
const adminQueueBox = document.getElementById("adminQueueBox");

const adminAddName = document.getElementById("adminAddName");
const adminAddBtn = document.getElementById("adminAddBtn");

const showerControlPanel = document.getElementById("showerControlPanel");
const plannedTimeInput = document.getElementById("plannedTimeInput");
const setPlannedBtn = document.getElementById("setPlannedBtn");
const plannedHint = document.getElementById("plannedHint");
const pauseAllBtn = document.getElementById("pauseAllBtn");
const resumeAllBtn = document.getElementById("resumeAllBtn");
const pauseHint = document.getElementById("pauseHint");
const resetTimerBtn = document.getElementById("resetTimerBtn");

function roomsRef(){ return ref(db, `queues/${mode}/rooms`); }
function roomRoot(){ return `queues/${mode}/rooms/${roomId}`; }
function stateCurrentRef(){ return ref(db, `${roomRoot()}/state/current`); }
function queueRef(){ return ref(db, `${roomRoot()}/queue`); }
function controlRef(){ return ref(db, `${roomRoot()}/control`); }
function controlPlannedRef(){ return ref(db, `${roomRoot()}/control/plannedStartAt`); }
function controlPausedRef(){ return ref(db, `${roomRoot()}/control/isPaused`); }
function timerRef(){ return ref(db, `${roomRoot()}/timer`); }

function fmtHHMM(ms){
  if(!ms) return "â€”";
  const d = new Date(ms);
  return `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
}

function setMode(next){
  mode = next;
  tabShower.classList.toggle("active", mode==="shower");
  tabWasher.classList.toggle("active", mode==="washer");
  roomId = "";
  showerControlPanel.style.display = (mode==="shower") ? "block" : "none";
  loadRooms();
}
tabShower.addEventListener("click", ()=>setMode("shower"));
tabWasher.addEventListener("click", ()=>setMode("washer"));

function detach(){
  if(unsubCurrent) unsubCurrent();
  if(unsubQueue) unsubQueue();
  if(unsubControl) unsubControl();
  unsubCurrent=unsubQueue=unsubControl=null;
}

function renderRooms(){
  roomSelect.innerHTML = "";
  const entries = Object.entries(roomMap || {});
  if(entries.length === 0){
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "ï¼ˆæ²’æœ‰æˆ¿é–“/æ©Ÿå°ï¼Œè«‹æ–°å¢ï¼‰";
    roomSelect.appendChild(opt);
    roomHint.textContent = "ç›®å‰æ²’æœ‰æˆ¿é–“/æ©Ÿå°ï¼Œè«‹å…ˆæ–°å¢ã€‚";
    roomId = "";
    return;
  }

  entries.sort((a,b)=> String(a[1]?.name||"").localeCompare(String(b[1]?.name||""), "zh-Hant"));
  if(!roomId || !roomMap[roomId]) roomId = entries[0][0];

  for(const [id, v] of entries){
    const opt = document.createElement("option");
    opt.value = id;
    opt.textContent = v?.name ? v.name : id;
    opt.selected = (id === roomId);
    roomSelect.appendChild(opt);
  }

  roomHint.textContent = `ç›®å‰é¸æ“‡ï¼š${roomMap?.[roomId]?.name || roomId}`;
}

function renderQueue(){
  nextEl.textContent = queueCache[0]?.name || "â€”";
  thirdEl.textContent = queueCache[1]?.name || "â€”";

  adminQueueBox.innerHTML = "";
  queueCache.forEach((q, idx)=>{
    const row = document.createElement("div");
    row.className = "qitem";
    row.innerHTML = `
      <div class="qname">${idx+1}. ${q.name}</div>
      <div class="qtools">
        <button class="mini miniNow" data-act="now" data-key="${q.key}">è¨­ç‚ºç¾åœ¨</button>
        <button class="mini miniUpDown" data-act="up" data-key="${q.key}">â†‘</button>
        <button class="mini miniUpDown" data-act="down" data-key="${q.key}">â†“</button>
        <button class="mini miniDel" data-act="del" data-key="${q.key}">åˆª</button>
      </div>
    `;
    adminQueueBox.appendChild(row);
  });
}

function renderControl(){
  if(mode!=="shower"){ return; }
  plannedHint.textContent = `å¯é–‹å§‹æ™‚é–“ï¼š${controlPlannedStartAt ? fmtHHMM(controlPlannedStartAt) : "â€”"}`;
  pauseHint.textContent = `ç‹€æ…‹ï¼š${controlIsPaused ? "æš«åœä¸­" : "æ­£å¸¸"}`;
}

function attach(){
  detach();
  if(!roomId) return;

  unsubCurrent = onValue(stateCurrentRef(), (snap)=>{
    currentEl.textContent = (snap.exists() && snap.val()) ? snap.val() : "â€”";
  });

  unsubQueue = onValue(queueRef(), (snap)=>{
    const data = snap.val() || {};
    const arr = Object.entries(data).map(([key, v]) => ({
      key, name: v?.name ?? "", ts: v?.ts ?? 0
    })).filter(x=>String(x.name).trim());
    arr.sort((a,b)=>a.ts-b.ts);
    queueCache = arr;
    renderQueue();
  });

  unsubControl = onValue(controlRef(), (snap)=>{
    const c = snap.exists() ? (snap.val()||{}) : {};
    controlPlannedStartAt = c.plannedStartAt ? Number(c.plannedStartAt) : null;
    controlIsPaused = !!c.isPaused;
    renderControl();
  });
}

function loadRooms(){
  if(unsubRooms) unsubRooms();
  roomHint.textContent = "è¼‰å…¥ä¸­â€¦";
  unsubRooms = onValue(roomsRef(), (snap)=>{
    roomMap = snap.val() || {};
    renderRooms();
    attach();
    showerControlPanel.style.display = (mode==="shower") ? "block" : "none";
  });
}

roomSelect.addEventListener("change", ()=>{
  roomId = roomSelect.value;
  renderRooms();
  attach();
});

document.getElementById("refreshRoomsBtn").addEventListener("click", loadRooms);

document.getElementById("addRoomBtn").addEventListener("click", async ()=>{
  if(!isLoggedIn()) return alert("è«‹å…ˆç™»å…¥ç®¡ç†å“¡");
  const name = String(document.getElementById("newRoomName").value || "").trim();
  if(!name) return alert("è«‹è¼¸å…¥åç¨±");
  const newId = `room_${Date.now()}`;
  await set(ref(db, `queues/${mode}/rooms/${newId}`), { name });

  // æ´—æ¾¡æˆ¿é–“ï¼šåˆå§‹åŒ– control
  if(mode==="shower"){
    await set(ref(db, `queues/${mode}/rooms/${newId}/control`), { plannedStartAt: null, isPaused: false });
    await set(ref(db, `queues/${mode}/rooms/${newId}/timer`), { durationMs: DURATION_MS, startAt: null, isRunning: false, pausedAt: null, pausedTotalMs: 0 });
  }

  document.getElementById("newRoomName").value = "";
});

document.getElementById("deleteRoomBtn").addEventListener("click", async ()=>{
  if(!isLoggedIn()) return alert("è«‹å…ˆç™»å…¥ç®¡ç†å“¡");
  if(!roomId) return alert("æ²’æœ‰å¯åˆªçš„æˆ¿é–“/æ©Ÿå°");
  const roomName = roomMap?.[roomId]?.name || roomId;
  if(!confirm(`ç¢ºå®šåˆªé™¤ã€Œ${roomName}ã€ï¼Ÿï¼ˆå« current èˆ‡ queueï¼‰`)) return;
  await remove(ref(db, `queues/${mode}/rooms/${roomId}`));
  roomId = "";
});

/** âœ… ç®¡ç†å“¡åŠ å…¥æ’éšŠï¼ˆå›ä¾†äº†ï¼‰ */
adminAddBtn.addEventListener("click", async ()=>{
  if(!isLoggedIn()) return alert("è«‹å…ˆç™»å…¥ç®¡ç†å“¡");
  if(!roomId) return alert("è«‹å…ˆé¸æˆ¿é–“/æ©Ÿå°");
  const name = String(adminAddName.value || "").trim();
  if(!name) return;
  await push(queueRef(), { name, ts: Date.now() });
  adminAddName.value = "";
});

/** æ´—æ¾¡æ§åˆ¶ï¼šè¨­å®šé–‹å§‹æ™‚é–“/æš«åœ */
setPlannedBtn.addEventListener("click", async ()=>{
  if(mode!=="shower") return;
  if(!isLoggedIn()) return alert("è«‹å…ˆç™»å…¥ç®¡ç†å“¡");
  if(!roomId) return alert("è«‹å…ˆé¸æˆ¿é–“");
  const t = String(plannedTimeInput.value || "");
  if(!t) return alert("è«‹é¸æ“‡æ™‚é–“ï¼ˆHH:MMï¼‰");
  const [hh, mm] = t.split(":").map(Number);
  const now = new Date();
  const d = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm, 0, 0);
  await set(controlPlannedRef(), d.getTime());
});

pauseAllBtn.addEventListener("click", async ()=>{
  if(mode!=="shower") return;
  if(!isLoggedIn()) return alert("è«‹å…ˆç™»å…¥ç®¡ç†å“¡");
  if(!roomId) return alert("è«‹å…ˆé¸æˆ¿é–“");
  await set(controlPausedRef(), true);
});

resumeAllBtn.addEventListener("click", async ()=>{
  if(mode!=="shower") return;
  if(!isLoggedIn()) return alert("è«‹å…ˆç™»å…¥ç®¡ç†å“¡");
  if(!roomId) return alert("è«‹å…ˆé¸æˆ¿é–“");
  await set(controlPausedRef(), false);
});

resetTimerBtn.addEventListener("click", async ()=>{
  if(mode!=="shower") return;
  if(!isLoggedIn()) return alert("è«‹å…ˆç™»å…¥ç®¡ç†å“¡");
  if(!roomId) return alert("è«‹å…ˆé¸æˆ¿é–“");
  if(!confirm("ç¢ºå®šé‡è¨­è¨ˆæ™‚ï¼Ÿï¼ˆä¸‹ä¸€ä½/ç›®å‰éœ€é‡æ–°æŒ‰é–‹å§‹ï¼‰")) return;
  await set(timerRef(), { durationMs: DURATION_MS, startAt: null, isRunning: false, pausedAt: null, pausedTotalMs: 0 });
});

document.getElementById("clearCurrentBtn").addEventListener("click", async ()=>{
  if(!isLoggedIn()) return alert("è«‹å…ˆç™»å…¥ç®¡ç†å“¡");
  if(!roomId) return alert("è«‹å…ˆé¸æˆ¿é–“/æ©Ÿå°");
  if(!confirm("ç¢ºå®šæ¸…ç©º currentï¼Ÿ")) return;
  await set(stateCurrentRef(), null);
  if(mode==="shower"){
    await set(timerRef(), { durationMs: DURATION_MS, startAt: null, isRunning: false, pausedAt: null, pausedTotalMs: 0 });
  }
});

document.getElementById("clearQueueBtn").addEventListener("click", async ()=>{
  if(!isLoggedIn()) return alert("è«‹å…ˆç™»å…¥ç®¡ç†å“¡");
  if(!roomId) return alert("è«‹å…ˆé¸æˆ¿é–“/æ©Ÿå°");
  if(!confirm("ç¢ºå®šæ¸…ç©ºæ•´å€‹ queueï¼Ÿ")) return;
  await set(queueRef(), null);
});

/** éšŠä¼æ“ä½œ */
async function rewriteQueueOrderFromCache(){
  const base = Date.now();
  const obj = {};
  queueCache.forEach((q,i)=>{ obj[q.key] = { name:q.name, ts: base+i }; });
  await set(queueRef(), Object.keys(obj).length ? obj : null);
}

adminQueueBox.addEventListener("click", async (e)=>{
  const btn = e.target.closest("button");
  if(!btn) return;
  if(!isLoggedIn()) return alert("è«‹å…ˆç™»å…¥ç®¡ç†å“¡");
  if(!roomId) return alert("è«‹å…ˆé¸æˆ¿é–“/æ©Ÿå°");

  const act = btn.dataset.act;
  const key = btn.dataset.key;
  const idx = queueCache.findIndex(x=>x.key===key);
  if(idx < 0) return;

  if(act==="del"){
    if(!confirm("ç¢ºå®šç§»é™¤ï¼Ÿ")) return;
    await remove(ref(db, `${roomRoot()}/queue/${key}`));
    return;
  }

  if(act==="now"){
    const name = queueCache[idx].name;
    if(!confirm(`ç¢ºå®šè¨­ã€Œ${name}ã€ç‚ºç¾åœ¨ï¼Ÿï¼ˆä¸¦å¾éšŠä¼ç§»é™¤ï¼‰`)) return;
    await set(stateCurrentRef(), name);
    await remove(ref(db, `${roomRoot()}/queue/${key}`));
    // æ´—æ¾¡ï¼šè¨­ç‚ºç¾åœ¨å¾Œé‡ç½® timerï¼Œè®“ä»–è‡ªå·±æŒ‰é–‹å§‹
    if(mode==="shower"){
      await set(timerRef(), { durationMs: DURATION_MS, startAt: null, isRunning: false, pausedAt: null, pausedTotalMs: 0 });
    }
    return;
  }

  if(act==="up" && idx>0){
    [queueCache[idx-1], queueCache[idx]] = [queueCache[idx], queueCache[idx-1]];
    await rewriteQueueOrderFromCache(); return;
  }
  if(act==="down" && idx<queueCache.length-1){
    [queueCache[idx+1], queueCache[idx]] = [queueCache[idx], queueCache[idx+1]];
    await rewriteQueueOrderFromCache(); return;
  }
});

/** init */
showerControlPanel.style.display = "block";
loadRooms();
</script>
</body>
</html>
